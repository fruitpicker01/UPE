import os, base64, json, time, requests, tempfile
from io import BytesIO
from datetime import datetime
import pandas as pd
import gradio as gr
from PIL import Image
import langchain_gigachat
import langchain_openai
import langchain_together
from langchain.schema import SystemMessage, HumanMessage
from langchain_gigachat.chat_models import GigaChat
from langchain_openai import ChatOpenAI
from langchain_together import ChatTogether
from openai import OpenAI
import openpyxl
import re, textwrap
from openpyxl.styles import Font, Border, Side
import pymorphy3

from bs4 import BeautifulSoup
from selenium import webdriver
from selenium.webdriver.chrome.service import Service as ChromeService
from webdriver_manager.chrome import ChromeDriverManager
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

REPO = "..."
UPLOAD_DIR = "uploads"
REGENERATES_DIR = "regenerates"

USERNAME = "..."
PASSWORD = "..."

TEMPLATE_ORDER = [
    "–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞", "–°—É—Ç—å –ø—Ä–æ–¥—É–∫—Ç–∞", "–°—É—Ç—å –∑–∞–¥–∞—á", "–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è",
    "–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ø—Ä–æ–¥—É–∫—Ç–∞", "–ë–∏–∑–Ω–µ—Å-–ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å",
    "–ë–∏–∑–Ω–µ—Å-—Å–∏—Ç—É–∞—Ü–∏–∏, –≤ –∫–æ—Ç–æ—Ä—ã—Ö –ø—Ä–æ–¥—É–∫—Ç –ø–æ–ª–µ–∑–µ–Ω",
    "–ö–∞–∫ –ø–æ–Ω—è—Ç—å, —á—Ç–æ –ø—Ä–æ—è–≤–∏–ª–∞—Å—å –±–∏–∑–Ω–µ—Å-–ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å",
    "–í—ã–≥–æ–¥–∞ –æ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞",
    "–ö–∞–∫ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç", "–°—Ç–æ–∏–º–æ—Å—Ç—å", "–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã",
    "–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –°–±–µ—Ä–∞ –ø–æ –ø—Ä–æ–¥—É–∫—Ç—É",
    "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∏–∑–Ω–µ—Å–µ –∫–ª–∏–µ–Ω—Ç–∞", "–í–æ–∑–º–æ–∂–Ω—ã–µ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ –∏ –æ—Ç–≤–µ—Ç—ã",
    "–ö–ª—é—á–µ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ", "–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ"
]

ALL_FIELDS = TEMPLATE_ORDER.copy()

SCRIPT_SECTIONS = [
    "–í–æ–≤–ª–µ—á–µ–Ω–∏–µ 1",
    "–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ 1","–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ 2", "–°—Ç–æ–∏–º–æ—Å—Ç—å", "–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ",
    "–í–æ–∑—Ä–∞–∂–µ–Ω–∏–µ 1","–í–æ–∑—Ä–∞–∂–µ–Ω–∏–µ 2","–í–æ–∑—Ä–∞–∂–µ–Ω–∏–µ 3",
    "–í–æ–∑—Ä–∞–∂–µ–Ω–∏–µ 4","–í–æ–∑—Ä–∞–∂–µ–Ω–∏–µ 5","–í–æ–∑—Ä–∞–∂–µ–Ω–∏–µ 6",
]

STRICT_MODELS = {"DeepSeek V3", "DeepSeek R1", "DeepSeek R1-0528"}

THINK_RE = re.compile(r"<think>.*?</think>", re.I | re.S)

LENGTH_RE = re.compile(r"\n+------\n–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–Ω–∞–∫–æ–≤:\s*\d+\s*$", re.S)

MAX_WORDS_OBJECTION = 6

def _count_words(txt: str) -> int:

    return len(re.findall(r'\b\w+\b', txt))

def _shorten_text_via_llm(
        model_name: str,
        prompt_template: str,
        src_text: str,
        checker: callable,
        max_try: int = 10
) -> tuple[str, bool, str]:

    if checker(src_text):
        return src_text, False, ""

    for _ in range(max_try):
        prompt = prompt_template.format(src=src_text)
        cand   = clean_response(call_llm(model_name, prompt))
        if checker(cand):
            return cand, True, prompt
    return src_text, False, ""

MAX_OBJS          = 20
OBJS_TO_KEEP_EMPTY = 6

MAX_TRY_OBJS = 10

for i in range(1, MAX_OBJS + 1):
    sec = f"–í–æ–∑—Ä–∞–∂–µ–Ω–∏–µ {i}"
    if sec not in SCRIPT_SECTIONS:
        SCRIPT_SECTIONS.append(sec)

OBJ_RE = re.compile(
    r"–í–æ–∑—Ä–∞–∂–µ–Ω–∏–µ\s*(\d+)\s*:(.*?)\s*–û—Ç–≤–µ—Ç\s*:(.*?)(?=–í–æ–∑—Ä–∞–∂–µ–Ω–∏–µ\s*\d+\s*:|$)",
    re.I | re.S,
)

OBJ_REPLY_TEMPLATE = (
    "–ù–∞–ø–∏—à–∏ –ª–∞–∫–æ–Ω–∏—á–Ω—ã–π –æ—Ç–≤–µ—Ç –∏–∑ 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π (–Ω–µ –±–æ–ª–µ–µ 4) —Å—É–º–º–∞—Ä–Ω–æ–π –¥–ª–∏–Ω–æ–π "
    "**—Å—Ç—Ä–æ–≥–æ –Ω–µ –±–æ–ª–µ–µ 350 –∑–Ω–∞–∫–æ–≤ —Å –ø—Ä–æ–±–µ–ª–∞–º–∏** –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–µ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞: ¬´{obj}¬ª.\n"
    "–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞: {name}\n"
    "–°—É—Ç—å –ø—Ä–æ–¥—É–∫—Ç–∞: {essence}\n"
    "–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ø—Ä–æ–¥—É–∫—Ç–∞:\n{func}\n"
    "–í—ã–≥–æ–¥–∞ –æ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞:\n{benefit}\n"
    "–ö–∞–∫ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç:\n{how_apply}\n"
    "–°—Ç–æ–∏–º–æ—Å—Ç—å:\n{cost}\n"
    "–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –°–±–µ—Ä–∞ –ø–æ –ø—Ä–æ–¥—É–∫—Ç—É:\n{advantage}\n"
    "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∏–∑–Ω–µ—Å–µ –∫–ª–∏–µ–Ω—Ç–∞:\n{biz}\n"
    "–ö–ª—é—á–µ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è: {key_msg}\n"
    "–°—Ç–∏–ª—å ‚Äì –¥–µ–ª–æ–≤–æ–π, –±–µ–∑ –≤–æ—Å–∫–ª–∏—Ü–∞–Ω–∏–π.\n"
    "–£–±–µ–¥–∏—Å—å, —á—Ç–æ –≤—Å–µ —Ñ–∞–∫—Ç—ã –≤ –æ—Ç–≤–µ—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –∏—Å—Ö–æ–¥–Ω—ã–º –¥–∞–Ω–Ω—ã–º.\n"
    "–û—Ç–≤–µ—Ç—å —Ç–æ–ª—å–∫–æ —Ç—Ä–µ–±—É–µ–º—ã–º –∞–±–∑–∞—Ü–µ–º."
)

MAX_LEN_GENERAL = 350
MAX_LEN_ENGAGEMENT = 300
MAX_LEN_COST_DESIGN = 300
MAX_LEN_ADVANTAGES = 500

def _is_blank(x: str) -> bool:
    return x is None or not x.strip()

def _get_prompt_line(label: str, value: str) -> str:

    if _is_blank(value):
        return ""

    return f"{label}:\n{value}\n"

def _get_advantage1_content(advantage: str, benefit: str, essence: str) -> str:

    if not _is_blank(advantage):
        return _get_prompt_line("–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –°–±–µ—Ä–∞ –ø–æ –ø—Ä–æ–¥—É–∫—Ç—É", advantage)
    elif not _is_blank(benefit):
        return _get_prompt_line("–í—ã–≥–æ–¥–∞ –æ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞", benefit)
    else:
        return _get_prompt_line("–°—É—Ç—å –ø—Ä–æ–¥—É–∫—Ç–∞", essence)

def _get_advantage2_content(func: str, benefit: str, essence: str) -> str:

    if not _is_blank(func):
        return _get_prompt_line("–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ø—Ä–æ–¥—É–∫—Ç–∞", func)
    elif not _is_blank(benefit):
        return _get_prompt_line("–í—ã–≥–æ–¥–∞ –æ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞", benefit)
    else:
        return _get_prompt_line("–°—É—Ç—å –ø—Ä–æ–¥—É–∫—Ç–∞", essence)

def _build_answer_prompt(objection: str,
                         name: str, essence: str, func: str, benefit: str,
                         how_apply: str, cost: str, advantage: str,
                         biz: str, key_msg: str) -> str:

    body = "".join([
        _get_prompt_line("–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞", name),
        _get_prompt_line("–°—É—Ç—å –ø—Ä–æ–¥—É–∫—Ç–∞", essence),
        _get_prompt_line("–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ø—Ä–æ–¥—É–∫—Ç–∞", func),
        _get_prompt_line("–í—ã–≥–æ–¥–∞ –æ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞", benefit),
        _get_prompt_line("–ö–∞–∫ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç", how_apply),
        _get_prompt_line("–°—Ç–æ–∏–º–æ—Å—Ç—å", cost),
        _get_prompt_line("–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –°–±–µ—Ä–∞ –ø–æ –ø—Ä–æ–¥—É–∫—Ç—É", advantage),
        _get_prompt_line("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∏–∑–Ω–µ—Å–µ –∫–ª–∏–µ–Ω—Ç–∞", biz),
        _get_prompt_line("–ö–ª—é—á–µ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", key_msg),
    ])
    return (
        f"–ù–∞–ø–∏—à–∏ –ª–∞–∫–æ–Ω–∏—á–Ω—ã–π –æ—Ç–≤–µ—Ç –∏–∑ 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π (–Ω–µ –±–æ–ª–µ–µ 4) —Å—É–º–º–∞—Ä–Ω–æ–π –¥–ª–∏–Ω–æ–π "
        f"**—Å—Ç—Ä–æ–≥–æ –Ω–µ –±–æ–ª–µ–µ 350 –∑–Ω–∞–∫–æ–≤ —Å –ø—Ä–æ–±–µ–ª–∞–º–∏** –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–µ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞: ¬´{objection}¬ª.\n"
        f"{body}"
        "–°—Ç–∏–ª—å ‚Äì –¥–µ–ª–æ–≤–æ–π, –±–µ–∑ –≤–æ—Å–∫–ª–∏—Ü–∞–Ω–∏–π.\n"
        "–£–±–µ–¥–∏—Å—å, —á—Ç–æ –≤—Å–µ —Ñ–∞–∫—Ç—ã –≤ –æ—Ç–≤–µ—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –∏—Å—Ö–æ–¥–Ω—ã–º –¥–∞–Ω–Ω—ã–º.\n"
        "–û—Ç–≤–µ—Ç—å —Ç–æ–ª—å–∫–æ —Ç—Ä–µ–±—É–µ–º—ã–º –∞–±–∑–∞—Ü–µ–º."
    )

def _build_answer_prompt_structured(objection: str,
                                    name: str, essence: str, func: str, benefit: str,
                                    how_apply: str, cost: str, advantage: str,
                                    biz: str, key_msg: str) -> str:

    body = "".join([
        _get_prompt_line("–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞", name),
        _get_prompt_line("–°—É—Ç—å –ø—Ä–æ–¥—É–∫—Ç–∞", essence),
        _get_prompt_line("–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ø—Ä–æ–¥—É–∫—Ç–∞", func),
        _get_prompt_line("–í—ã–≥–æ–¥–∞ –æ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞", benefit),
        _get_prompt_line("–ö–∞–∫ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç", how_apply),
        _get_prompt_line("–°—Ç–æ–∏–º–æ—Å—Ç—å", cost),
        _get_prompt_line("–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –°–±–µ—Ä–∞ –ø–æ –ø—Ä–æ–¥—É–∫—Ç—É", advantage),
        _get_prompt_line("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∏–∑–Ω–µ—Å–µ –∫–ª–∏–µ–Ω—Ç–∞", biz),
        _get_prompt_line("–ö–ª—é—á–µ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", key_msg),
    ])
    return (
        f"–ù–∞–ø–∏—à–∏ –ª–∞–∫–æ–Ω–∏—á–Ω—ã–π –æ—Ç–≤–µ—Ç –∏–∑ 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π (–Ω–µ –±–æ–ª–µ–µ 4) —Å—É–º–º–∞—Ä–Ω–æ–π –¥–ª–∏–Ω–æ–π "
        f"**—Å—Ç—Ä–æ–≥–æ –Ω–µ –±–æ–ª–µ–µ 350 –∑–Ω–∞–∫–æ–≤ —Å –ø—Ä–æ–±–µ–ª–∞–º–∏** –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–µ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞: ¬´{objection}¬ª "
        f"–ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É ¬´–ü–æ–Ω–∏–º–∞—é ‚Üí –û–±—ä—è—Å–Ω—è—é ‚Üí –ü—Ä–µ–¥–ª–∞–≥–∞—é¬ª.\n"
        f"{body}"
        "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞:\n"
        "1) –ü–æ–Ω–∏–º–∞—é ‚Äì –ø–æ–∫–∞–∂–∏ —Å–æ—á—É–≤—Å—Ç–≤–∏–µ –∫ —Å–∏—Ç—É–∞—Ü–∏–∏.\n"
        "2) –û–±—ä—è—Å–Ω—è—é ‚Äì –∫—Ä–∞—Ç–∫–æ —Ä–∞—Å–∫—Ä–æ–π, –∫–∞–∫ –ø—Ä–æ–¥—É–∫—Ç —Ä–µ—à–∞–µ—Ç –±–æ–ª—å (1-2 –≤—ã–≥–æ–¥—ã –±–µ–∑ —Ü–∏—Ñ—Ä-–¥–∞–≤–ª–µ–Ω–∏—è).\n"
        "3) –ü—Ä–µ–¥–ª–∞–≥–∞—é ‚Äì –º—è–≥–∫–æ –ø—Ä–∏–≥–ª–∞—Å–∏ –∫ –¥–∏–∞–ª–æ–≥—É (¬´–ú–æ–≥—É –ø—Ä–∏—Å–ª–∞—Ç—å –ø—Ä–∏–º–µ—Ä‚Ä¶?¬ª).\n"
        "–°—Ç–∏–ª—å ‚Äì –¥–µ–ª–æ–≤–æ–π, –±–µ–∑ –≤–æ—Å–∫–ª–∏—Ü–∞–Ω–∏–π.\n"
        "–¢–æ–Ω: —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω—ã–π, –∑–∞–±–æ—Ç–ª–∏–≤—ã–π; –∏–∑–±–µ–≥–∞–π —Å–ª–æ–≤ ¬´–¥–æ–ª–∂–Ω—ã/–æ–±—è–∑–∞–Ω—ã¬ª –∏ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã—Ö –ø—Ä–∏–∑—ã–≤–æ–≤.\n"
        "–£–±–µ–¥–∏—Å—å, —á—Ç–æ –≤—Å–µ —Ñ–∞–∫—Ç—ã –≤ –æ—Ç–≤–µ—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –∏—Å—Ö–æ–¥–Ω—ã–º –¥–∞–Ω–Ω—ã–º.\n"
        "–û—Ç–≤–µ—Ç—å —Ç–æ–ª—å–∫–æ —Ç—Ä–µ–±—É–µ–º—ã–º –∞–±–∑–∞—Ü–µ–º."
    )

def parse_task_essences(raw: str) -> list[str] | None:

    if not raw or not raw.strip():
        return []

    pattern = r"–°—É—Ç—å –∑–∞–¥–∞—á–∏\s*(\d+)\s*:\s*(.+?)(?=–°—É—Ç—å –∑–∞–¥–∞—á–∏\s*\d+\s*:|$)"
    matches = re.findall(pattern, raw, re.IGNORECASE | re.DOTALL)

    if not matches:
        return None

    tasks = []
    expected_num = 1

    for num_str, task_text in matches:
        num = int(num_str)
        if num != expected_num:
            return None

        task_text = task_text.strip()
        if not task_text:
            return None

        tasks.append(task_text)
        expected_num += 1

    return tasks

def parse_objections(raw: str, *, max_items: int = 15) -> list[str] | None:
    if not raw or not raw.strip():
        return []

    lines = raw.splitlines()
    res, cur_num, cur_v, cur_a, mode = [], None, [], [], None

    for ln in lines:
        ln_stripped = ln.strip()

        m_num = re.match(r"^–í–æ–∑—Ä–∞–∂–µ–Ω–∏–µ\s*(\d+)\s*:(.*)", ln_stripped, re.I)
        if m_num:

            if cur_num is not None:
                res.append(
                    f"–í–æ–∑—Ä–∞–∂–µ–Ω–∏–µ {cur_num}: {' '.join(cur_v).strip()}\n"
                    f"–û—Ç–≤–µ—Ç: {' '.join(cur_a).strip()}"
                )
            cur_num = int(m_num.group(1))
            cur_v, cur_a = [m_num.group(2).strip()], []
            mode = "V"
            continue

        m_ans = re.match(r"^–û—Ç–≤–µ—Ç\s*:(.*)", ln_stripped, re.I)
        if m_ans:
            cur_a = [m_ans.group(1).strip()]
            mode = "A"
            continue

        if mode == "V":
            cur_v.append(ln_stripped)
        elif mode == "A":
            cur_a.append(ln_stripped)

    if cur_num is not None:
        res.append(
            f"–í–æ–∑—Ä–∞–∂–µ–Ω–∏–µ {cur_num}: {' '.join(cur_v).strip()}\n"
            f"–û—Ç–≤–µ—Ç: {' '.join(cur_a).strip()}"
        )

    nums = [int(re.match(r"–í–æ–∑—Ä–∞–∂–µ–Ω–∏–µ (\d+):", r).group(1)) for r in res]
    if nums != list(range(1, len(nums) + 1)):
        return None

    return res[:max_items]

def _parse_six_objections(raw_text: str) -> list[str] | None:

    items = []

    m_ptrn = re.compile(r"^\s*(\d+)\s*[\)\.\:\-‚Äì‚Äî]\s*(.+?)\s*$", re.MULTILINE)

    matches = m_ptrn.findall(raw_text)

    if len(matches) < 6:
        return None

    try:
        nums = [int(num) for num, txt in matches]
        if nums[:6] != [1, 2, 3, 4, 5, 6]:
            return None

        return [txt.strip() for num, txt in matches[:6]]
    except (ValueError, IndexError):
        return None

def process_all_objections(
        raw_original_objections: str,
        llm_name: str,
        detect_prompt: str,
        name: str, essence: str, func: str, benefit: str,
        how_apply: str, cost: str, advantage: str, biz: str, key_msg: str
    ):

    matches = list(OBJ_RE.finditer(raw_original_objections or ""))
    nums    = [int(m.group(1)) for m in matches]
    if not matches or nums != list(range(1, len(nums)+1)):
        gr.Warning(
            "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª–µ ¬´–í–æ–∑–º–æ–∂–Ω—ã–µ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ –∏ –æ—Ç–≤–µ—Ç—ã¬ª. "
            "–û–Ω–æ –¥–æ–ª–∂–Ω–æ –∏–º–µ—Ç—å —Ñ–æ—Ä–º–∞—Ç ‚Äì "
            "–í–æ–∑—Ä–∞–∂–µ–Ω–∏–µ 1: ‚Ä¶ –û—Ç–≤–µ—Ç: ‚Ä¶ –í–æ–∑—Ä–∞–∂–µ–Ω–∏–µ 2: ‚Ä¶ –û—Ç–≤–µ—Ç: ‚Ä¶ –∏ —Ç.–¥."
        )
        matches = []

    original_items: list[dict] = []

    obj_prompt_tpl = (
        "–°–æ–∫—Ä–∞—Ç–∏ —Å–ª–µ–¥—É—é—â–∏–π —Ç–µ–∫—Å—Ç –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –æ–±—â–µ–≥–æ —Å–º—ã—Å–ª–∞ "
        "**—Å—Ç—Ä–æ–≥–æ –¥–æ 6 —Å–ª–æ–≤ –∏–ª–∏ –º–µ–Ω—å—à–µ**: {src}\n"
        "–û—Ç–≤–µ—Ç—å —Ç–æ–ª—å–∫–æ —Ç—Ä–µ–±—É–µ–º—ã–º —Ç–µ–∫—Å—Ç–æ–º."
    )
    ans_prompt_tpl = (
        "–°–æ–∫—Ä–∞—Ç–∏ —Å–ª–µ–¥—É—é—â–∏–π —Ç–µ–∫—Å—Ç –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –æ–±—â–µ–≥–æ —Å–º—ã—Å–ª–∞ –¥–æ 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π "
        "(–Ω–µ –±–æ–ª–µ–µ 4) —Å—É–º–º–∞—Ä–Ω–æ–π –¥–ª–∏–Ω–æ–π **—Å—Ç—Ä–æ–≥–æ –Ω–µ –±–æ–ª–µ–µ 350 –∑–Ω–∞–∫–æ–≤ —Å –ø—Ä–æ–±–µ–ª–∞–º–∏**: {src}\n"
        ""
        "–ù–ò –í –ö–û–ï–ú –°–õ–£–ß–ê–ï –Ω–µ –¥–æ–±–∞–≤–ª—è–π —Ñ–∞–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –∏—Å—Ö–æ–¥–Ω–æ–º —Ç–µ–∫—Å—Ç–µ.\n"
        "–û—Ç–≤–µ—Ç—å —Ç–æ–ª—å–∫–æ —Ç—Ä–µ–±—É–µ–º—ã–º —Ç–µ–∫—Å—Ç–æ–º."
    )

    for m in matches:
        num       = int(m.group(1))
        obj_raw   = m.group(2).strip()
        ans_raw   = m.group(3).strip()

        obj_fin, obj_changed, obj_prompt = _shorten_text_via_llm(
            llm_name, obj_prompt_tpl, obj_raw,
            lambda t: _count_words(t) <= MAX_WORDS_OBJECTION
        )
        if obj_changed: print("[OBJ_PROMPT]", obj_prompt)

        if len(ans_raw) > MAX_LEN_GENERAL:

            structured_prompt = _build_answer_prompt_structured(
                obj_fin, name, essence, func, benefit,
                how_apply, cost, advantage, biz, key_msg
            )
            ans_fin = single_llm(llm_name, structured_prompt, essence, func, benefit, how_apply, cost, advantage, biz, key_msg)
            ans_changed = True
            ans_prompt = structured_prompt
            print("[STRUCTURED_ANS_PROMPT]", ans_prompt)
        else:
            ans_fin, ans_changed, ans_prompt = ans_raw, False, ""

        obj_hdr = f"–í–æ–∑—Ä–∞–∂–µ–Ω–∏–µ {num}"
        if obj_changed:
            obj_hdr += " (–ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–æ LLM)"
        ans_hdr = "–û—Ç–≤–µ—Ç"
        if ans_changed:
            ans_hdr += " (–ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–æ LLM) [–ü–æ–Ω–∏–º–∞–Ω–∏–µ]"

        final_txt = (
            f"{obj_hdr}: {obj_fin}\n"
            f"{ans_hdr}: {ans_fin}\n\n"
            f"------\n–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–Ω–∞–∫–æ–≤ –≤ –æ—Ç–≤–µ—Ç–µ: {len(ans_fin)}"
        )

        if ans_changed:
            answer_prompt_full = ans_prompt
        else:
            answer_prompt_full = _build_answer_prompt(
                obj_fin, name, essence, func, benefit,
                how_apply, cost, advantage, biz, key_msg
            )

        original_items.append({
            "text":   final_txt,
            "prompt": answer_prompt_full,
            "unlock": True
        })

    total_orig = len(original_items)

    name, essence, func, benefit, how_apply, cost, advantage, biz, key_msg = [
        ensure_period(t) for t in
        [name, essence, func, benefit, how_apply, cost, advantage, biz, key_msg]
    ]
    all_sources = (essence, func, benefit, how_apply, cost, advantage, biz, key_msg)

    new_questions = None
    if detect_prompt and not detect_prompt.startswith("–ü—Ä–æ–º–ø—Ç –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è"):
        gr.Info("–ì–µ–Ω–µ—Ä–∞—Ü–∏—è 6 –Ω–æ–≤—ã—Ö –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–π‚Ä¶")
        for _ in range(1, MAX_TRY_OBJS + 1):
            raw = single_llm(llm_name, detect_prompt, *all_sources)
            new_questions = _parse_six_objections(raw)
            if new_questions: break
        if not new_questions:
            gr.Warning("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å 6 –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–π.")
    new_questions = new_questions or []

    new_objections_full = []
    for i, q in enumerate(new_questions):
        gr.Info(f"–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞: ¬´{q[:30]}‚Ä¶¬ª")

        use_structured = (i + 1) % 3 == 0

        if use_structured:
            reply_prompt = _build_answer_prompt_structured(
                q, name, essence, func, benefit,
                how_apply, cost, advantage, biz, key_msg
            )
        else:
            prompt_body = "".join([
                _get_prompt_line(l, v) for l, v in [
                    ("–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞", name), ("–°—É—Ç—å –ø—Ä–æ–¥—É–∫—Ç–∞", essence),
                    ("–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ø—Ä–æ–¥—É–∫—Ç–∞", func), ("–í—ã–≥–æ–¥–∞ –æ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞", benefit),
                    ("–ö–∞–∫ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç", how_apply), ("–°—Ç–æ–∏–º–æ—Å—Ç—å", cost),
                    ("–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –°–±–µ—Ä–∞ –ø–æ –ø—Ä–æ–¥—É–∫—Ç—É", advantage),
                    ("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∏–∑–Ω–µ—Å–µ –∫–ª–∏–µ–Ω—Ç–∞", biz), ("–ö–ª—é—á–µ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", key_msg)
            ] ])
            reply_prompt = (
                f"–ù–∞–ø–∏—à–∏ –ª–∞–∫–æ–Ω–∏—á–Ω—ã–π –æ—Ç–≤–µ—Ç –∏–∑ 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π (–Ω–µ –±–æ–ª–µ–µ 4) —Å—É–º–º–∞—Ä–Ω–æ–π –¥–ª–∏–Ω–æ–π "
                f"**—Å—Ç—Ä–æ–≥–æ –Ω–µ –±–æ–ª–µ–µ 350 –∑–Ω–∞–∫–æ–≤ —Å –ø—Ä–æ–±–µ–ª–∞–º–∏** –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–µ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞: ¬´{q}¬ª.\n"
                f"{prompt_body}"
                "–°—Ç–∏–ª—å ‚Äì –¥–µ–ª–æ–≤–æ–π, –±–µ–∑ –≤–æ—Å–∫–ª–∏—Ü–∞–Ω–∏–π.\n"
                "–£–±–µ–¥–∏—Å—å, —á—Ç–æ –≤—Å–µ —Ñ–∞–∫—Ç—ã –≤ –æ—Ç–≤–µ—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –∏—Å—Ö–æ–¥–Ω—ã–º –¥–∞–Ω–Ω—ã–º.\n"
                "–û—Ç–≤–µ—Ç—å —Ç–æ–ª—å–∫–æ —Ç—Ä–µ–±—É–µ–º—ã–º –∞–±–∑–∞—Ü–µ–º."
            )

        answer = single_llm(llm_name, reply_prompt, *all_sources)

        answer_label = "–û—Ç–≤–µ—Ç (–ø—Ä–∏–¥—É–º–∞–Ω–æ LLM)"
        if use_structured:
            answer_label += " [–ü–æ–Ω–∏–º–∞–Ω–∏–µ]"

        full_text = (
            f"–í–æ–∑—Ä–∞–∂–µ–Ω–∏–µ (–ø—Ä–∏–¥—É–º–∞–Ω–æ LLM): {q}\n"
            f"{answer_label}: {answer}\n\n"
            f"------\n–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–Ω–∞–∫–æ–≤ –≤ –æ—Ç–≤–µ—Ç–µ: {len(answer)}"
        )
        new_objections_full.append({"text": full_text, "prompt": reply_prompt})

    gr.Info("‚úîÔ∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")

    total_visible = total_orig + len(new_objections_full)

    row_updates            = [gr.update(visible=(i < total_visible)) for i in range(MAX_OBJS)]
    box_updates            = [gr.update(value="")] * MAX_OBJS
    btn_updates            = [gr.update(interactive=True)] * MAX_OBJS
    hidden_prompt_updates  = [gr.update(value="")] * MAX_OBJS
    llm_prompt_box_updates = [gr.update(value="")] * 6

    for i, itm in enumerate(original_items):
        box_updates[i]   = gr.update(value=itm["text"], interactive=True)
        btn_updates[i]   = gr.update(interactive=itm["unlock"])
        hidden_prompt_updates[i] = gr.update(value=itm["prompt"])

    for j, itm in enumerate(new_objections_full, start=total_orig):
        box_updates[j]   = gr.update(value=itm["text"], interactive=True)
        hidden_prompt_updates[j] = gr.update(value=itm["prompt"])
        if j-total_orig < len(llm_prompt_box_updates):
            llm_prompt_box_updates[j-total_orig] = gr.update(value=itm["prompt"])

    return tuple(row_updates + box_updates + btn_updates +
                 llm_prompt_box_updates + hidden_prompt_updates)

def single_llm(model_name: str, prompt: str, *sources: str) -> str:

    raw = call_llm(model_name, prompt)
    return postprocess_llm(raw, *sources)

def retry_llm(model_name: str,
              prompt: str,
              *sources: str,
              max_try: int = 10,
              max_len: int = MAX_LEN_GENERAL
              ) -> str:

    for attempt in range(1, max_try + 1):
        raw  = call_llm(model_name, prompt)
        resp = postprocess_llm(raw, *sources)
        length_ok = len(resp) <= max_len
        bullets   = resp.count("‚úîÔ∏è")

        if length_ok and bullets != 1:
            return resp

    return (f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ ‚â§ {max_len} –∑–Ω–∞–∫–æ–≤ –∏ –±–µ–∑ –æ–¥–∏–Ω–æ—á–Ω–æ–≥–æ "
            "–±—É–ª–ª–∏—Ç–∞ –∑–∞ 10 –ø–æ–ø—ã—Ç–æ–∫")

def strip_length(text: str) -> str:

    if not text:
        return ""
    return LENGTH_RE.sub("", text).rstrip()

def with_length(text: str) -> str:

    return f"{text}\n\n------\n–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–Ω–∞–∫–æ–≤: {len(text)}"

_gc_key   = os.getenv("GC_KEY_CORP")
_openai   = os.getenv("GPT_KEY")
_together = os.getenv("TOGETHER_KEY")

_gc_common = dict(
    credentials=_gc_key,
    temperature=1.15,
    verify_ssl_certs=False,
    scope="GIGACHAT_API_CORP"
)

chat_pool: dict[str, callable] = {

    "GigaChat-2-Max":          lambda: GigaChat(model="GigaChat-2-Max", **_gc_common),

    "ChatGPT-4o": lambda: ChatOpenAI(api_key=_openai,  model="gpt-4o"),
    "DeepSeek V3": lambda: ChatTogether(api_key=_together,
                                        model="deepseek-ai/DeepSeek-V3"),
    "DeepSeek R1-0528": lambda: ChatTogether(api_key=_together,
                                        model="deepseek-ai/DeepSeek-R1")
}

def maybe_with_length(text: str) -> str:

    if text.startswith("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞ 10"):
        return text
    return with_length(text)

def call_llm(model_name: str, prompt: str) -> str:

    if model_name not in chat_pool:
        return f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –º–æ–¥–µ–ª—å: {model_name}"

    client = chat_pool[model_name]

    if not hasattr(client, "invoke"):
        client = client()
        chat_pool[model_name] = client

    try:
        res = client.invoke(
            [SystemMessage(content=""), HumanMessage(content=prompt)]
        )
        return res.content.strip()
    except Exception as e:
        return f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ {model_name}: {e}"

def refine_section(model_name: str,
                   base_prompt: str,
                   prev_answer: str,
                   clarification: str,
                   *sources: str
                   ):

    if base_prompt.startswith("–ü—Ä–æ–º–ø—Ç –¥–ª—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –Ω–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω"):
        msg = "–ë–ª–æ–∫ –Ω–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω, –ø–æ—Å–∫–æ–ª—å–∫—É –≤ –±—Ä–∏—Ñ–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏."
        return (
            gr.update(value=msg, interactive=True),
            gr.update(value="")
        )
    if base_prompt.startswith("–ü—Ä–æ–º–ø—Ç –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –Ω–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω"):
        msg = "–ë–ª–æ–∫ –Ω–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω, –ø–æ—Å–∫–æ–ª—å–∫—É –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏."
        return (
            gr.update(value=msg, interactive=True),
            gr.update(value="")
        )

    strict = model_name in STRICT_MODELS
    clarification = clarification.strip()

    has_care_label = prev_answer.startswith("[–ó–∞–±–æ—Ç–∞]")

    prev_clean = strip_length(prev_answer)

    if clarification:
        full_prompt = build_refine_prompt(
            base_prompt, prev_clean, clarification,
            strict_postfix=strict
        )
    else:
        full_prompt = base_prompt.strip()

    is_cost   = base_prompt.startswith("–ü—Ä–æ–º–ø—Ç –¥–ª—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏")
    is_format = base_prompt.startswith("–ü—Ä–æ–º–ø—Ç –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è")
    is_advantages = "–ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞" in base_prompt.lower() or "–ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤" in base_prompt.lower()
    is_engagement = ("–≤–æ–≤–ª–µ—á–µ–Ω–∏–µ" in base_prompt.lower() or
                    "—Å—É—Ç—å –∑–∞–¥–∞—á" in base_prompt.lower() or
                    "—Å—É—Ç—å –∑–∞–¥–∞—á–∏" in base_prompt.lower())

    if is_cost or is_format:
        limit = MAX_LEN_COST_DESIGN
    elif is_advantages:
        limit = MAX_LEN_ADVANTAGES
    elif is_engagement:
        limit = MAX_LEN_ENGAGEMENT
    else:
        limit = MAX_LEN_GENERAL

    answer = retry_llm(model_name, full_prompt, *sources, max_len=limit)

    if has_care_label:
        answer = f"[–ó–∞–±–æ—Ç–∞] {answer}"

    answer_ui = maybe_with_length(answer)

    try:
        save_regenerate_json(
            section=base_prompt.splitlines()[0].split(":")[0]
                              .replace("–ü—Ä–æ–º–ø—Ç –¥–ª—è ", "")
                              .capitalize(),
            prompt=base_prompt,
            old_resp=prev_clean,
            clarification=clarification,
            new_resp=answer
        )
        save_regenerate_to_excel(
            section=base_prompt.splitlines()[0].split(":")[0]
                              .replace("–ü—Ä–æ–º–ø—Ç –¥–ª—è ", "")
                              .capitalize(),
            prompt=base_prompt,
            old_resp=prev_clean,
            clarification=clarification,
            new_resp=answer
        )
    except Exception as exc:
        gr.Warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–æ–≥–∏ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {exc}")

    return (
        gr.update(value=answer_ui, interactive=True),
        gr.update(value="")
    )

def refine_llm_objection(model_name, base_prompt, scr_tb, clar_tb):

    prev_answer    = scr_tb
    clarification  = clar_tb.strip()

    lines   = prev_answer.splitlines()
    header  = lines[0]

    ans_idx = next((i for i,l in enumerate(lines) if l.lower().startswith("–æ—Ç–≤–µ—Ç")), 1)

    ans_line = lines[ans_idx] if ans_idx < len(lines) else ""
    has_understanding = "[–ü–æ–Ω–∏–º–∞–Ω–∏–µ]" in ans_line

    old_ans = " ".join(lines[ans_idx:]).split("------")[0].strip()
    objection_txt = header.split(":",1)[1].strip()

    if clarification:
        prompt = build_refine_prompt(base_prompt, old_ans, clarification)
    else:
        prompt = base_prompt.strip()

    raw   = call_llm(model_name, prompt)
    ans   = clean_response(raw)
    if len(ans) > MAX_LEN_GENERAL:
        ans = ans[:MAX_LEN_GENERAL]

    ans_label = "–û—Ç–≤–µ—Ç (–ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–æ LLM)"
    if has_understanding:
        ans_label += " [–ü–æ–Ω–∏–º–∞–Ω–∏–µ]"

    new_block = (
        f"{header}\n"
        f"{ans_label}: {ans}\n\n"
        f"------\n–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–Ω–∞–∫–æ–≤ –≤ –æ—Ç–≤–µ—Ç–µ: {len(ans)}"
    )

    return (
        gr.update(value=new_block, interactive=True),
        gr.update(value="")
    )

morph = pymorphy3.MorphAnalyzer()

NUM_RE  = r'([0-9]+(?:[.,][0-9]+)?)'
UNIT_RE = r'(\s*[%‚ÇΩ]|[–∞-—è–ê-–Ø—ë–Å]+)?'

def _norm_num(num: str) -> str:

    return str(float(num.replace(',', '.'))).rstrip('0').rstrip('.')

def _norm_unit(unit: str) -> str:
    u = unit.strip().lower()

    if u in {'%', '–ø—Ä–æ—Ü–µ–Ω—Ç', '–ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤'}: return '%'
    if not u:
        return '%'
    return morph.parse(u)[0].normal_form

def fix_limit_wording(text: str, *sources: str) -> str:

    ref_pairs: set[tuple[str, str]] = set()
    patt_ref = re.compile(
        r'\b–¥–æ\s+([0-9]+(?:[.,][0-9]+)?)\s*(%|‚ÇΩ|[A-Za-z–ê-–Ø–∞-—è—ë–Å]+)?',
        re.I
    )
    for src in filter(None, sources):
        for m in patt_ref.finditer(src):
            ref_pairs.add((_norm_num(m.group(1)),
                           _norm_unit(m.group(2) or '')))

    if not ref_pairs:
        return text

    patt_gen = re.compile(
        r'\b(–æ—Ç|–∑–∞)\s+([0-9]+(?:[.,][0-9]+)?)\s*(%|‚ÇΩ|[A-Za-z–ê-–Ø–∞-—è—ë–Å]+)?',
        re.I
    )

    def _repl(m: re.Match) -> str:
        num_raw, unit_raw = m.group(2), (m.group(3) or '')
        pair = (_norm_num(num_raw), _norm_unit(unit_raw))
        if pair in ref_pairs:

            if unit_raw.strip() in {'%', '‚ÇΩ'}:
                return f'–¥–æ {num_raw}{unit_raw}'
            space = ' ' if unit_raw else ''
            return f'–¥–æ {num_raw}{space}{unit_raw}'
        return m.group(0)

    return patt_gen.sub(_repl, text)

def postprocess_llm(raw_resp: str, *sources: str) -> str:

    if '%%' in raw_resp or re.search(r'(?<!\d)%[\s.,:;!?]', raw_resp):
        print("[DEBUG %-issue BEFORE]", raw_resp)

    txt = clean_response(raw_resp)
    txt = fix_limit_wording(txt, *sources)

    txt = re.sub(r'%%+', '%', txt)

    txt = re.sub(r'(?<!\d)%(?=[\s.,:;!?]|$)', '', txt)

    if '%%' in txt or re.search(r'(?<!\d)%[\s.,:;!?]', txt):
        print("[DEBUG %-issue AFTER ]", txt)

    print("[FINAL ]:", txt.replace("\n", "‚èé"))

    return txt

def gh_headers():
    token = os.getenv("GITHUB_TOKEN")
    h = {"Accept": "application/vnd.github+json"}
    if token: h["Authorization"] = f"token {token}"
    return h

def gh_read(path:str)->bytes:
    url=f"https://api.github.com/repos/{REPO}/contents/{path}"
    r=requests.get(url,headers=gh_headers(),timeout=15); r.raise_for_status()
    return base64.b64decode(r.json()["content"])

def gh_write(path: str, data: bytes, msg: str, sha: str | None = None):
    url  = f"https://api.github.com/repos/{REPO}/contents/{path}"
    body = {
        "message": msg,
        "content": base64.b64encode(data).decode()
    }
    if sha:
        body["sha"] = sha
    r = requests.put(url, headers=gh_headers(), data=json.dumps(body), timeout=15)
    if r.status_code not in (200, 201):
        raise gr.Warning(f"GitHub error {r.status_code}: {r.text}")

def gh_image(path: str) -> Image.Image:

    data = gh_read(path)
    return Image.open(BytesIO(data))

def download_template():

    bin_data = gh_read("–®–∞–±–ª–æ–Ω –¥–ª—è –±—Ä–∏—Ñ–∞.xlsx")
    tmp_dir  = tempfile.mkdtemp()
    path     = os.path.join(tmp_dir, "–®–∞–±–ª–æ–Ω –¥–ª—è –±—Ä–∏—Ñ–∞.xlsx")
    with open(path, "wb") as f:
        f.write(bin_data)
    return gr.update(value=path, visible=True)

def parse_excel(binary: bytes):
    df = pd.read_excel(BytesIO(binary), header=None, engine="openpyxl")

    df[1] = df[1].apply(lambda x: "" if pd.isna(x) else x)
    mapping = dict(zip(df[0], df[1]))
    return [
        gr.update(value=mapping.get(k, ""), interactive=True)
        for k in TEMPLATE_ORDER
    ]

def fill_fields(choice):
    if choice == "–°–≤–æ–π –ø—Ä–æ–¥—É–∫—Ç":
        return [gr.update(value="", interactive=True) for _ in boxes]

    file_name = f"{choice}.xlsx"
    try:
        bin_data = gh_read(file_name)
        return parse_excel(bin_data)
    except Exception as e:
        return [gr.update(value="", interactive=True) for _ in boxes]

def upload_and_fill(xlsx_file):

    if xlsx_file is None:
        return [gr.update()] * 14

    try:
        df = pd.read_excel(xlsx_file, header=None, engine="openpyxl")
    except Exception as e:
        gr.Warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å Excel: {e}")
        return [gr.update()] * 14

    if df[0].tolist() != TEMPLATE_ORDER:
        gr.Warning("–§–∞–π–ª –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —à–∞–±–ª–æ–Ω–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ!")
        return [gr.update()] * 14

    binary = open(xlsx_file, "rb").read()
    try:
        base_name = os.path.splitext(os.path.basename(xlsx_file))[0]
        unix = int(time.time())
        gh_write(f"{UPLOAD_DIR}/{base_name}_{unix}.xlsx",
                 binary,
                 f"upload {base_name}.xlsx {unix}")
    except Exception as e:
        gr.Warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞ GitHub: {e}")

    return parse_excel(binary)

def regenerate(sec,clar):
    return f"üîÑ {sec} (–æ–±–Ω–æ–≤–ª–µ–Ω–æ {datetime.now():%H:%M:%S})"

def change_tab(idx:int): return gr.update(selected=idx)

def restore_yo(text: str) -> str:
    morph = pymorphy3.MorphAnalyzer()

    def fix_word(word: str) -> str:

        if not re.search(r'[–ê-–Ø–∞-—è–Å—ë]', word):
            return word
        if word.isupper() or word.lower() == "–≤—Å–µ":
            return word
        parsed = morph.parse(word)[0]
        restored = parsed.word

        if word and word[0].isupper():
            restored = restored.capitalize()
        return restored

    tokens = re.split(r'(\s+)', text)
    tokens = [fix_word(tok) if not tok.isspace() else tok for tok in tokens]
    return ''.join(tokens)

def clean_response(txt: str) -> str:

    if not txt:
        return ""

    txt = THINK_RE.sub("", txt)

    lines = [l.rstrip() for l in txt.splitlines() if l.strip()]

    bullet_in   = re.compile(r"^\s*[‚Ä¢¬∑‚Äî-]\s*")
    bullet_out  = "‚úîÔ∏è "
    first_up    = re.compile(r"^(\s*‚úîÔ∏è\s*)([A-Z–ê-–Ø–Å])")
    glued_last  = re.compile(
        r"^(\s*‚úîÔ∏è\s*)([^.;]+?)([.;])\s+([A-Z–ê-–Ø–Å].+)$"
    )
    tail_punct  = re.compile(r"[.;]\s*$")

    processed = []
    for line in lines:
        line = bullet_in.sub(bullet_out, line)

        m = first_up.match(line)
        if m:
            line = f"{m.group(1)}{m.group(2).lower()}{line[m.end(2):]}"

        g = glued_last.match(line)
        if g:
            processed.append(f"{g.group(1)}{g.group(2).strip()}")
            processed.append(g.group(4).strip())
            continue

        if line.lstrip().startswith("‚úîÔ∏è"):
            line = tail_punct.sub("", line)

        processed.append(line)

    fixed = []
    for ln in processed:
        if ln.lstrip().startswith("‚úîÔ∏è") and "‚úîÔ∏è" in ln.lstrip()[1:]:
            ln = re.sub(r'\s+‚úîÔ∏è\s*', r'\n‚úîÔ∏è ', ln).strip()
        fixed.extend(ln.splitlines())
    processed = fixed

    dedup = []
    for ln in processed:
        if not dedup or ln.strip() != dedup[-1].strip():
            dedup.append(ln)
    processed = dedup

    txt_out = "\n".join(processed)
    txt_out = restore_yo(txt_out)
    txt_out = re.sub(r"YouKassa|YooKassa|Ykassa", "–Ækassa", txt_out)
    txt_out = re.sub(r"–∫—É–ø–µ—Ä", "–ö—É–ø–µ—Ä", txt_out)
    txt_out = re.sub(r"–∞—à–∞–Ω", "–ê—à–∞–Ω", txt_out)
    txt_out = re.sub(r"–ª–µ–Ω—Ç–∞", "–õ–µ–Ω—Ç–∞", txt_out)
    txt_out = re.sub(r"–∫–æ–º—É—Å", "–ö–æ–º—É—Å", txt_out)
    txt_out = re.sub(r"–∫–æ–º—É—Å–∞", "–ö–æ–º—É—Å", txt_out)
    txt_out = re.sub(r"–î–æ–º.—Ä—Ñ", "–î–æ–º.–†–§", txt_out)
    txt_out = re.sub(r"–î–æ–º.—Ä—Ñ", "–î–æ–º.–†–§", txt_out)
    txt_out = re.sub(r"—Å–±–µ—Ä–ª–∏–∑–∏–Ω–≥", "–°–±–µ—Ä–õ–∏–∑–∏–Ω–≥", txt_out)
    txt_out = re.sub(r"–°–±–µ—Ä–±–∏–∑–Ω–µ—Å.–∂–∫—Ö", "–°–±–µ—Ä–ë–∏–∑–Ω–µ—Å.–ñ–ö–•", txt_out)
    txt_out = re.sub(r"—Å–±–µ—Ä–±–∏–∑–Ω–µ—Å.–∂–∫—Ö", "–°–±–µ—Ä–ë–∏–∑–Ω–µ—Å.–ñ–ö–•", txt_out)
    txt_out = re.sub(r"–°–±–µ—Ä–±–∞–Ω–∫.–±–∏–∑–Ω–µ—Å.–∂–∫—Ö", "–°–±–µ—Ä–ë–∏–∑–Ω–µ—Å.–ñ–ö–•", txt_out)
    txt_out = re.sub(r"Sms", "SMS", txt_out)
    txt_out = re.sub(r"sberPay", "SberPay", txt_out)
    txt_out = re.sub(r"qr", "QR", txt_out)
    txt_out = re.sub(r'\s[-‚Äì‚Äî]\s', ' ‚Äî ', txt_out)
    txt_out = re.sub(r'(?<=\d)[-‚Äì‚Äî](?=\d)', '‚Äì', txt_out)
    txt_out = re.sub(r'(?<=[A-Za-z–ê-–Ø–∞-—è0-9])[-‚Äì‚Äî](?=[A-Za-z–ê-–Ø–∞-—è0-9])', '-', txt_out)
    txt_out = re.sub(r'(\*|_|`)+', '', txt_out)
    txt_out = re.sub(r'[\"\'¬´¬ª‚Äú‚Äù‚Äû‚Äü‚Äπ‚Ä∫‚Äò‚Äô‚Äö‚Äõ]', '', txt_out)

    return txt_out.strip()

def build_refine_prompt(base_prompt: str,
                        prev_answer: str,
                        clarification: str,
                        strict_postfix: bool = False) -> str:

    blocks = [
        "User:",
        base_prompt.strip(),
        "",
        "Assistant:",
        clean_response(prev_answer),
        "",
        "User:",
        clarification.strip(),
        "",
        "Assistant:"
    ]
    prompt = "\n".join(blocks)
    return prompt

def save_comment_json(comment: str):

    ts = int(time.time())
    payload = {
        "timestamp": ts,
        "comment": comment or "(–ø—É—Å—Ç–æ)"
    }
    gh_write(
        f"comments/comment_{ts}.json",
        json.dumps(payload, ensure_ascii=False, indent=2).encode(),
        f"add comment {ts}"
    )

def save_comment_to_excel(comment: str):
    cols = ["timestamp", "comment"]
    ts   = int(time.time())

    try:
        meta = requests.get(
            f"https://api.github.com/repos/{REPO}/contents/comments/comments.xlsx",
            headers=gh_headers(), timeout=15
        )
        if meta.status_code == 200:
            sha     = meta.json()["sha"]
            content = base64.b64decode(meta.json()["content"])
            df      = pd.read_excel(BytesIO(content), engine="openpyxl")
            if list(df.columns) != cols:
                df = pd.DataFrame(columns=cols)
        else:
            sha = None
            df  = pd.DataFrame(columns=cols)
    except Exception:
        sha = None
        df  = pd.DataFrame(columns=cols)

    df.loc[len(df)] = [ts, comment or "(–ø—É—Å—Ç–æ)"]

    buf = BytesIO()
    with pd.ExcelWriter(buf, engine="openpyxl") as xls:
        df.to_excel(xls, index=False)

    gh_write(
        "comments/comments.xlsx",
        buf.getvalue(),
        f"update comments.xlsx ({ts})",
        sha=sha
    )

def save_comment(comment_text: str):

    save_comment_json(comment_text)
    save_comment_to_excel(comment_text)
    return gr.update(value="–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!", interactive=True)

def save_prompt_json(llm, prompt_std, engagement_std):
    ts = int(time.time())
    payload = {
        "timestamp": ts,
        "llm": llm,
        "prompt_engagement": prompt_std,
        "engagement": engagement_std,
    }
    gh_write(
        f"prompts/prompt_{ts}.json",
        json.dumps(payload, ensure_ascii=False, indent=2).encode(),
        f"add prompt {ts}"
    )

def save_prompt_to_excel(llm, prompt_std, engagement_std):
    cols = ["timestamp", "llm",
            "prompt_engagement",
            "engagement"]
    ts   = int(time.time())

    try:
        meta = requests.get(
            f"https://api.github.com/repos/{REPO}/contents/prompts/prompts.xlsx",
            headers=gh_headers(), timeout=15
        )
        if meta.status_code == 200:
            sha     = meta.json()["sha"]
            content = base64.b64decode(meta.json()["content"])
            df      = pd.read_excel(BytesIO(content), engine="openpyxl")
        else:
            sha = None
            df  = pd.DataFrame(columns=cols)
    except Exception:
        sha = None
        df  = pd.DataFrame(columns=cols)

    df.loc[len(df)] = [ts, llm, prompt_std, engagement_std]

    buf = BytesIO()
    with pd.ExcelWriter(buf, engine="openpyxl") as xls:
        df.to_excel(xls, index=False)

    gh_write(
        "prompts/prompts.xlsx",
        buf.getvalue(),
        f"update prompts.xlsx ({ts})",
        sha=sha
    )

def save_prompts(llm, prompt_std, engagement_std):

    try:
        save_prompt_json(llm, prompt_std, engagement_std)
        save_prompt_to_excel(llm, prompt_std, engagement_std)
    except Exception as exc:
        gr.Warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–º–ø—Ç—ã: {exc}")

def save_regenerate_json(section: str,
                         prompt: str,
                         old_resp: str,
                         clarification: str,
                         new_resp: str):

    ts = int(time.time())
    payload = {
        "timestamp": ts,
        "section": section,
        "prompt": prompt,
        "old_response": old_resp or "(–ø—É—Å—Ç–æ)",
        "clarification": clarification or "(–ø—É—Å—Ç–æ)",
        "new_response": new_resp or "(–ø—É—Å—Ç–æ)"
    }
    gh_write(
        f"{REGENERATES_DIR}/regenerate_{ts}.json",
        json.dumps(payload, ensure_ascii=False, indent=2).encode(),
        f"add regenerate {ts}"
    )

def save_regenerate_to_excel(section: str,
                             prompt: str,
                             old_resp: str,
                             clarification: str,
                             new_resp: str):

    cols = ["timestamp", "section",
            "prompt", "old_response",
            "clarification", "new_response"]
    ts   = int(time.time())

    try:
        meta = requests.get(
            f"https://api.github.com/repos/{REPO}/contents/{REGENERATES_DIR}/regenerates.xlsx",
            headers=gh_headers(), timeout=15
        )
        if meta.status_code == 200:
            sha     = meta.json()["sha"]
            content = base64.b64decode(meta.json()["content"])
            df      = pd.read_excel(BytesIO(content), engine="openpyxl")
        else:
            sha = None
            df  = pd.DataFrame(columns=cols)
    except Exception:
        sha = None
        df  = pd.DataFrame(columns=cols)

    df.loc[len(df)] = [
        ts, section, prompt,
        old_resp or "(–ø—É—Å—Ç–æ)",
        clarification or "(–ø—É—Å—Ç–æ)",
        new_resp or "(–ø—É—Å—Ç–æ)"
    ]

    buf = BytesIO()
    with pd.ExcelWriter(buf, engine="openpyxl") as xls:
        df.to_excel(xls, index=False)

    gh_write(
        f"{REGENERATES_DIR}/regenerates.xlsx",
        buf.getvalue(),
        f"update regenerates.xlsx ({ts})",
        sha=sha
    )

def prepare_button_text():
    return gr.update(value="–°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è...", interactive=True)

def reset_button_text():
    time.sleep(2)
    return gr.update(value="–û—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π", interactive=True)

def ensure_period(text: str) -> str:

    if not text:
        return ""

    stripped = text.strip()
    if not stripped:
        return ""

    if stripped[-1] not in ".?!;":
        stripped += "."
    return stripped

def make_header(name_s: str,
                essence_s: str,
                need_s: str,
                cost_s: str) -> str:

    lines = [f"–ø—Ä–æ–¥—É–∫—Ç–∞: {name_s}"]
    if essence_s:
        lines.append(f"–°—É—Ç—å –ø—Ä–æ–¥—É–∫—Ç–∞: {essence_s}")
    if need_s:
        lines.append(f"–ö–∞–∫—É—é –±–∏–∑–Ω–µ—Å-–ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –∑–∞–∫—Ä—ã–≤–∞–µ—Ç: {need_s}")
    if cost_s:
        lines.append(f"–°—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–æ–¥—É–∫—Ç–∞: {cost_s}")
    return "\n".join(lines) + "\n"

def build_all_prompts(
    product_choice,
    name, essence, task_essences, key_msg, benefit, advantage,
    cost, design, func, biz
):

    name, essence, key_msg, benefit, advantage, cost, design, func, biz = [
        ensure_period(t) for t in
        [name, essence, key_msg, benefit, advantage, cost, design, func, biz]
    ]

    product_choice = (product_choice or "").strip()

    common_part = "".join([
        _get_prompt_line("–°—É—Ç—å –ø—Ä–æ–¥—É–∫—Ç–∞", essence),
        _get_prompt_line("–ö–ª—é—á–µ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", key_msg)
    ])

    advantages_part = "".join([
        _get_prompt_line("–í—ã–≥–æ–¥–∞ –æ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞", benefit),
        _get_prompt_line("–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –°–±–µ—Ä–∞ –ø–æ –ø—Ä–æ–¥—É–∫—Ç—É", advantage)
    ])

    common_hdr = (
        f"–¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞: {name}\n"
        f"{common_part}"
        "–í—ã–±–µ—Ä–∏ –¢–û–õ–¨–ö–û –°–ê–ú–£–Æ –í–ê–ñ–ù–£–Æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –∞–±–∑–∞—Ü–∞. –ö–∞–∂–¥–æ–µ —Å–ª–æ–≤–æ –Ω–∞ —Å—á–µ—Ç—É. "
        "–ù–ò –í –ö–û–ï–ú –°–õ–£–ß–ê–ï –Ω–µ –¥–æ–±–∞–≤–ª—è–π —Ñ–∞–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.\n"
    )
    standard_prompt = ""

    task_prompts = []
    parsed_tasks = []
    if not _is_blank(task_essences):
        parsed_tasks = parse_task_essences(task_essences)

    if parsed_tasks:
        structure_tasks = (
            "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∞–±–∑–∞—Ü–∞:\n"
            "1. –ù–∞—á–Ω–∏ —Å —É—Ç–≤–µ—Ä–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å —ç–º–ø–∞—Ç–∏—á–Ω—ã–º –ø—Ä–∏–∑–Ω–∞–Ω–∏–µ–º —Å–∏—Ç—É–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞: –∫—Ä–∞—Ç–∫–æ –æ–±–æ–∑–Ω–∞—á—å –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ç—Ä—É–¥–Ω–æ—Å—Ç—å –∏ –∫–∞–∫ –æ–Ω–∞ –º–µ—à–∞–µ—Ç —Ü–µ–ª—è–º/–æ—Ç–Ω–∏–º–∞–µ—Ç —Ä–µ—Å—É—Ä—Å—ã. –ü–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ ‚Äî —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–µ –∏–ª–∏ –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω–æ–µ. –ó–∞–ø—Ä–µ—â–µ–Ω—ã ¬´?¬ª, –≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ —Å–ª–æ–≤–∞ (¬´–∫–∞–∫¬ª, ¬´–ø–æ—á–µ–º—É¬ª, ¬´–∑–∞—á–µ–º¬ª, ¬´–∫–æ–≥–¥–∞¬ª, ¬´–≥–¥–µ¬ª, ¬´–ª–∏¬ª) –∏ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫–æ 2-–º—É –ª–∏—Ü—É (¬´–≤—ã/–≤–∞–º/–≤–∞—à¬ª) –≤ –ø–µ—Ä–≤–æ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏. –ó–∞–≤–µ—Ä—à–∏ —Ç–æ—á–∫–æ–π.\n"
            "2. –ü—Ä–æ–¥–æ–ª–∂–∏ –∑–∞–±–æ—Ç–ª–∏–≤—ã–º, –Ω–µ–Ω–∞–≤—è–∑—á–∏–≤—ã–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –ø–æ–º–æ—â–∏: –æ–ø–∏—à–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π –ø–æ–¥—Ö–æ–¥/–ø—Ä–∏–Ω—Ü–∏–ø –∫–∞–∫ —Å–ø–æ—Å–æ–± —Å–º—è–≥—á–∏—Ç—å —Ç—Ä—É–¥–Ω–æ—Å—Ç—å, —É–∫–∞–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –≤—ã–≥–æ–¥—É –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ –∏ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–æ–±–∞–≤—å —Å–ª–µ–¥—É—é—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª–∏–µ–Ω—Ç–µ: {task_essence}\n"
            "3. –ó–∞–≤–µ—Ä—à–∏ –æ—Ç–∫—Ä—ã—Ç—ã–º –≤–æ–ø—Ä–æ—Å–æ–º, –∫–∞–∫ –∫–ª–∏–µ–Ω—Ç —Å–µ–π—á–∞—Å —Ä–µ—à–∞–µ—Ç –æ–±–æ–∑–Ω–∞—á–µ–Ω–Ω—É—é —Ç—Ä—É–¥–Ω–æ—Å—Ç—å –∏ —á—Ç–æ –∏–º–µ–Ω–Ω–æ —Ö–æ—Ç–µ–ª–æ—Å—å –±—ã —É–ª—É—á—à–∏—Ç—å; –Ω–µ —É—Ç–æ—á–Ω—è–π, —á—Ç–æ —Å –ø–æ–º–æ—â—å—é –Ω–∞—à–µ–≥–æ —Å–µ—Ä–≤–∏—Å–∞.\n"
        )

        for task_essence in parsed_tasks:
            task_prompt = (
                f"–ù–∞–ø–∏—à–∏ –ø—Ä–µ–¥–µ–ª—å–Ω–æ –≤–æ–≤–ª–µ–∫–∞—é—â–∏–π –∏ –ª–∞–∫–æ–Ω–∏—á–Ω—ã–π –∞–±–∑–∞—Ü –∏–∑ 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π (–Ω–µ –±–æ–ª–µ–µ 4) —Å—É–º–º–∞—Ä–Ω–æ–π –¥–ª–∏–Ω–æ–π "
                f"**—Å—Ç—Ä–æ–≥–æ –Ω–µ –±–æ–ª–µ–µ 300 –∑–Ω–∞–∫–æ–≤ —Å –ø—Ä–æ–±–µ–ª–∞–º–∏** –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ {common_hdr}\n"
                f"{structure_tasks.format(task_essence=task_essence)}"
                "–°—Ç–∏–ª—å ‚Äì –¥–µ–ª–æ–≤–æ–π, –±–µ–∑ –≤–æ—Å–∫–ª–∏—Ü–∞–Ω–∏–π.\n"
                "–£–±–µ–¥–∏—Å—å, —á—Ç–æ –≤–∫–ª—é—á–∏–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª–∏–µ–Ω—Ç–µ –≤ –æ—Ç–≤–µ—Ç.\n"
                "–£–±–µ–¥–∏—Å—å, —á—Ç–æ –≤—Å–µ —Ñ–∞–∫—Ç—ã –≤ –æ—Ç–≤–µ—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –∏—Å—Ö–æ–¥–Ω—ã–º –¥–∞–Ω–Ω—ã–º.\n"
                "–û—Ç–≤–µ—Ç—å —Ç–æ–ª—å–∫–æ —Ç—Ä–µ–±—É–µ–º—ã–º –∞–±–∑–∞—Ü–µ–º."
            )
            task_prompts.append(task_prompt)

        standard_prompt = (
            f"–ù–∞–ø–∏—à–∏ –ø—Ä–µ–¥–µ–ª—å–Ω–æ –≤–æ–≤–ª–µ–∫–∞—é—â–∏–π –∏ –ª–∞–∫–æ–Ω–∏—á–Ω—ã–π –∞–±–∑–∞—Ü –∏–∑ 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π (–Ω–µ –±–æ–ª–µ–µ 4) —Å—É–º–º–∞—Ä–Ω–æ–π –¥–ª–∏–Ω–æ–π "
            f"**—Å—Ç—Ä–æ–≥–æ –Ω–µ –±–æ–ª–µ–µ 300 –∑–Ω–∞–∫–æ–≤ —Å –ø—Ä–æ–±–µ–ª–∞–º–∏** –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ {common_hdr}\n"
            "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∞–±–∑–∞—Ü–∞:\n"
            "1. –ù–∞—á–Ω–∏ —Å —É—Ç–≤–µ—Ä–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å —ç–º–ø–∞—Ç–∏—á–Ω—ã–º –ø—Ä–∏–∑–Ω–∞–Ω–∏–µ–º —Å–∏—Ç—É–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞: –∫—Ä–∞—Ç–∫–æ –æ–±–æ–∑–Ω–∞—á—å –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ç—Ä—É–¥–Ω–æ—Å—Ç—å –∏ –∫–∞–∫ –æ–Ω–∞ –º–µ—à–∞–µ—Ç —Ü–µ–ª—è–º/–æ—Ç–Ω–∏–º–∞–µ—Ç —Ä–µ—Å—É—Ä—Å—ã. –ü–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ ‚Äî —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–µ –∏–ª–∏ –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω–æ–µ. –ó–∞–ø—Ä–µ—â–µ–Ω—ã ¬´?¬ª, –≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ —Å–ª–æ–≤–∞ (¬´–∫–∞–∫¬ª, ¬´–ø–æ—á–µ–º—É¬ª, ¬´–∑–∞—á–µ–º¬ª, ¬´–∫–æ–≥–¥–∞¬ª, ¬´–≥–¥–µ¬ª, ¬´–ª–∏¬ª) –∏ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫–æ 2-–º—É –ª–∏—Ü—É (¬´–≤—ã/–≤–∞–º/–≤–∞—à¬ª) –≤ –ø–µ—Ä–≤–æ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏. –ó–∞–≤–µ—Ä—à–∏ —Ç–æ—á–∫–æ–π.\n"
            "2. –ü—Ä–æ–¥–æ–ª–∂–∏ –∑–∞–±–æ—Ç–ª–∏–≤—ã–º, –Ω–µ–Ω–∞–≤—è–∑—á–∏–≤—ã–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –ø–æ–º–æ—â–∏: –æ–ø–∏—à–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π –ø–æ–¥—Ö–æ–¥/–ø—Ä–∏–Ω—Ü–∏–ø –∫–∞–∫ —Å–ø–æ—Å–æ–± —Å–º—è–≥—á–∏—Ç—å —Ç—Ä—É–¥–Ω–æ—Å—Ç—å, —É–∫–∞–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –≤—ã–≥–æ–¥—É –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞.\n"
            "3. –ó–∞–≤–µ—Ä—à–∏ –æ—Ç–∫—Ä—ã—Ç—ã–º –≤–æ–ø—Ä–æ—Å–æ–º, –∫–∞–∫ –∫–ª–∏–µ–Ω—Ç —Å–µ–π—á–∞—Å —Ä–µ—à–∞–µ—Ç –æ–±–æ–∑–Ω–∞—á–µ–Ω–Ω—É—é —Ç—Ä—É–¥–Ω–æ—Å—Ç—å –∏ —á—Ç–æ –∏–º–µ–Ω–Ω–æ —Ö–æ—Ç–µ–ª–æ—Å—å –±—ã —É–ª—É—á—à–∏—Ç—å; –Ω–µ —É—Ç–æ—á–Ω—è–π, —á—Ç–æ —Å –ø–æ–º–æ—â—å—é –Ω–∞—à–µ–≥–æ —Å–µ—Ä–≤–∏—Å–∞.\n"
            "–°—Ç–∏–ª—å ‚Äì –¥–µ–ª–æ–≤–æ–π, –±–µ–∑ –≤–æ—Å–∫–ª–∏—Ü–∞–Ω–∏–π.\n"
            "–£–±–µ–¥–∏—Å—å, —á—Ç–æ –≤—Å–µ —Ñ–∞–∫—Ç—ã –≤ –æ—Ç–≤–µ—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –∏—Å—Ö–æ–¥–Ω—ã–º –¥–∞–Ω–Ω—ã–º.\n"
            "–û—Ç–≤–µ—Ç—å —Ç–æ–ª—å–∫–æ —Ç—Ä–µ–±—É–µ–º—ã–º –∞–±–∑–∞—Ü–µ–º."
        )
    else:
        if product_choice.upper().startswith("–û–¢–†"):
            standard_prompt = (
                f"–ù–∞–ø–∏—à–∏ –ø—Ä–µ–¥–µ–ª—å–Ω–æ –≤–æ–≤–ª–µ–∫–∞—é—â–∏–π –∏ –ª–∞–∫–æ–Ω–∏—á–Ω—ã–π –∞–±–∑–∞—Ü –∏–∑ 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π (–Ω–µ –±–æ–ª–µ–µ 4) —Å—É–º–º–∞—Ä–Ω–æ–π –¥–ª–∏–Ω–æ–π "
                f"**—Å—Ç—Ä–æ–≥–æ –Ω–µ –±–æ–ª–µ–µ 300 –∑–Ω–∞–∫–æ–≤ —Å –ø—Ä–æ–±–µ–ª–∞–º–∏** –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ {common_hdr}\n"
                "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∞–±–∑–∞—Ü–∞:\n"
                "1. –ù–∞—á–Ω–∏ —Å ¬´–Ø —ç–∫—Å–ø–µ—Ä—Ç¬ª (–∏ —É–∫–∞–∂–∏ –æ—Ç—Ä–∞—Å–ª—å, –∫–æ—Ç–æ—Ä–æ–π –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º—ã–π –ø—Ä–æ–¥—É–∫—Ç).\n"
                "2. –°–≤—è–∂–∏ –ø—Ä–æ–¥—É–∫—Ç —Å —Ä–µ—à–µ–Ω–∏–µ–º –ø—Ä–æ–±–ª–µ–º—ã: –æ–¥–∏–Ω —Ñ–∞–∫—Ç –∏–∑ –¥–∞–Ω–Ω—ã—Ö, –±–µ–∑ –æ—Ü–µ–Ω–æ—á–Ω—ã—Ö —Å–ª–æ–≤ –∏ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–π.\n"
                "3. –ó–∞–¥–∞–π –æ–¥–∏–Ω –∫–æ—Ä–æ—Ç–∫–∏–π –≤–æ–ø—Ä–æ—Å –æ —Ç–µ–∫—É—â–µ–º –ø—Ä–æ—Ü–µ—Å—Å–µ/–±–æ–ª–∏ –∫–ª–∏–µ–Ω—Ç–∞, —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–∑ –≥–ª–∞–≤–Ω–æ–π –∑–∞–¥–∞—á–∏ (–Ω–∞–ø—Ä.: ¬´–ö–∞–∫ –≤—ã —Å–µ–π—á–∞—Å [–¥–µ–π—Å—Ç–≤–∏–µ]?¬ª, ¬´–ß—Ç–æ –º–µ—à–∞–µ—Ç [—Ü–µ–ª—å]?¬ª. –ï—Å–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ 2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π, –æ–±—ä–µ–¥–∏–Ω–∏ 1) –∏ 2), –∞ –≤–æ–ø—Ä–æ—Å —Å–¥–µ–ª–∞–π –≤—Ç–æ—Ä—ã–º.\n"
                "–°—Ç–∏–ª—å ‚Äì –¥–µ–ª–æ–≤–æ–π, –±–µ–∑ –≤–æ—Å–∫–ª–∏—Ü–∞–Ω–∏–π.\n"
                "–£–±–µ–¥–∏—Å—å, —á—Ç–æ –≤—Å–µ —Ñ–∞–∫—Ç—ã –≤ –æ—Ç–≤–µ—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –∏—Å—Ö–æ–¥–Ω—ã–º –¥–∞–Ω–Ω—ã–º.\n"
                "–û—Ç–≤–µ—Ç—å —Ç–æ–ª—å–∫–æ —Ç—Ä–µ–±—É–µ–º—ã–º –∞–±–∑–∞—Ü–µ–º."
            )
        else:
            standard_prompt = (
                f"–ù–∞–ø–∏—à–∏ –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å **—Å—Ç—Ä–æ–≥–æ –Ω–µ –±–æ–ª–µ–µ 300 –∑–Ω–∞–∫–æ–≤ —Å –ø—Ä–æ–±–µ–ª–∞–º–∏** –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞: {name}\n"
                f"{_get_prompt_line('–°—É—Ç—å –ø—Ä–æ–¥—É–∫—Ç–∞', essence)}"
                f"{_get_prompt_line('–ö–ª—é—á–µ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', key_msg)}"
                "–ù—É–∂–Ω–æ —Å–ø—Ä–æ—Å–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞, –ø–ª–∞–Ω–∏—Ä—É–µ—Ç –ª–∏ –æ–Ω –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø—Ä–æ–¥—É–∫—Ç–æ–º ‚Äì –º–æ–∂–Ω–æ –Ω–∞—á–∞—Ç—å —Å ¬´–†–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç–µ –ª–∏ –í—ã¬ª, "
                "¬´–í–æ–∑–º–æ–∂–Ω–æ, –í—ã –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–ª–∏¬ª, ¬´–ü–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –ª–∏¬ª, ¬´–ü–æ–¥—Å–∫–∞–∂–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞¬ª."
            )

    while len(task_prompts) < 18:
        task_prompts.append("")

    adv1 = (
        f"–ù–∞–ø–∏—à–∏ –ø—Ä–µ–¥–µ–ª—å–Ω–æ –≤–æ–≤–ª–µ–∫–∞—é—â–∏–π –∏ –ª–∞–∫–æ–Ω–∏—á–Ω—ã–π –∞–±–∑–∞—Ü –∏–∑ 3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π (–Ω–µ –±–æ–ª–µ–µ 5) —Å—É–º–º–∞—Ä–Ω–æ–π –¥–ª–∏–Ω–æ–π "
        f"**—Å—Ç—Ä–æ–≥–æ –Ω–µ –±–æ–ª–µ–µ 500 –∑–Ω–∞–∫–æ–≤ —Å –ø—Ä–æ–±–µ–ª–∞–º–∏** –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ "
        f"–¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞: {name}\n"
        f"{_get_advantage1_content(advantage, benefit, essence)}"
        "–í—ã–±–µ—Ä–∏ –¢–û–õ–¨–ö–û –°–ê–ú–£–Æ –í–ê–ñ–ù–£–Æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –∞–±–∑–∞—Ü–∞. –ö–∞–∂–¥–æ–µ —Å–ª–æ–≤–æ –Ω–∞ —Å—á–µ—Ç—É. –ù–ò –í –ö–û–ï–ú –°–õ–£–ß–ê–ï –Ω–µ –¥–æ–±–∞–≤–ª—è–π —Ñ–∞–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.\n"
        "–°—Ç–∏–ª—å ‚Äì –¥–µ–ª–æ–≤–æ–π, –±–µ–∑ –≤–æ—Å–∫–ª–∏—Ü–∞–Ω–∏–π.\n"
        "–£–±–µ–¥–∏—Å—å, —á—Ç–æ –≤—Å–µ —Ñ–∞–∫—Ç—ã –≤ –æ—Ç–≤–µ—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –∏—Å—Ö–æ–¥–Ω—ã–º –¥–∞–Ω–Ω—ã–º.\n"
        "–û—Ç–≤–µ—Ç—å —Ç–æ–ª—å–∫–æ —Ç—Ä–µ–±—É–µ–º—ã–º –∞–±–∑–∞—Ü–µ–º."
    )

    adv2 = (
        f"–ù–∞–ø–∏—à–∏ –ø—Ä–µ–¥–µ–ª—å–Ω–æ –≤–æ–≤–ª–µ–∫–∞—é—â–∏–π –∏ –ª–∞–∫–æ–Ω–∏—á–Ω—ã–π –∞–±–∑–∞—Ü –∏–∑ 3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π (–Ω–µ –±–æ–ª–µ–µ 5) —Å—É–º–º–∞—Ä–Ω–æ–π –¥–ª–∏–Ω–æ–π "
        f"**—Å—Ç—Ä–æ–≥–æ –Ω–µ –±–æ–ª–µ–µ 500 –∑–Ω–∞–∫–æ–≤ —Å –ø—Ä–æ–±–µ–ª–∞–º–∏** –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ "
        f"–¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞: {name}\n"
        f"{_get_advantage2_content(func, benefit, essence)}"
        "–í—ã–±–µ—Ä–∏ –¢–û–õ–¨–ö–û –°–ê–ú–£–Æ –í–ê–ñ–ù–£–Æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –∞–±–∑–∞—Ü–∞. –ö–∞–∂–¥–æ–µ —Å–ª–æ–≤–æ –Ω–∞ —Å—á–µ—Ç—É. –ù–ò –í –ö–û–ï–ú –°–õ–£–ß–ê–ï –Ω–µ –¥–æ–±–∞–≤–ª—è–π —Ñ–∞–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.\n"
        "–°—Ç–∏–ª—å ‚Äì –¥–µ–ª–æ–≤–æ–π, –±–µ–∑ –≤–æ—Å–∫–ª–∏—Ü–∞–Ω–∏–π.\n"
        "–£–±–µ–¥–∏—Å—å, —á—Ç–æ –≤—Å–µ —Ñ–∞–∫—Ç—ã –≤ –æ—Ç–≤–µ—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –∏—Å—Ö–æ–¥–Ω—ã–º –¥–∞–Ω–Ω—ã–º.\n"
        "–û—Ç–≤–µ—Ç—å —Ç–æ–ª—å–∫–æ —Ç—Ä–µ–±—É–µ–º—ã–º –∞–±–∑–∞—Ü–µ–º."
    )

    if _is_blank(cost):
        cost_prompt = "–ü—Ä–æ–º–ø—Ç –¥–ª—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –Ω–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω, –ø–æ—Å–∫–æ–ª—å–∫—É –≤ –±—Ä–∏—Ñ–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏."
    else:
        cost_prompt = (
            f"–ù–∞–ø–∏—à–∏ –ª–∞–∫–æ–Ω–∏—á–Ω—ã–π –∞–±–∑–∞—Ü –ø—Ä–æ —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–æ–¥—É–∫—Ç–∞ –∏–∑ 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π (–Ω–µ –±–æ–ª–µ–µ 2) —Å—É–º–º–∞—Ä–Ω–æ–π –¥–ª–∏–Ω–æ–π "
            f"**—Å—Ç—Ä–æ–≥–æ –Ω–µ –±–æ–ª–µ–µ 300 –∑–Ω–∞–∫–æ–≤ —Å –ø—Ä–æ–±–µ–ª–∞–º–∏** –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ "
            f"–¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞: {name}\n"
            f"{_get_prompt_line('–°—É—Ç—å –ø—Ä–æ–¥—É–∫—Ç–∞', essence)}"
            f"{_get_prompt_line('–°—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–æ–¥—É–∫—Ç–∞', cost)}"
            "–°—Ç–∏–ª—å ‚Äì –¥–µ–ª–æ–≤–æ–π, –±–µ–∑ –≤–æ—Å–∫–ª–∏—Ü–∞–Ω–∏–π.\n"
            "–£–±–µ–¥–∏—Å—å, —á—Ç–æ –≤—Å–µ —Ñ–∞–∫—Ç—ã –≤ –æ—Ç–≤–µ—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –∏—Å—Ö–æ–¥–Ω—ã–º –¥–∞–Ω–Ω—ã–º.\n"
            "–ó–∞–≤–µ—Ä—à–∏ —Ñ—Ä–∞–∑–æ–π, —É–∫—Ä–µ–ø–ª—è—é—â–µ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ –≤—ã–≥–æ–¥–Ω–æ—Å—Ç–∏ –ø—Ä–æ–¥—É–∫—Ç–∞.\n"
            "–û—Ç–≤–µ—Ç—å —Ç–æ–ª—å–∫–æ —Ç—Ä–µ–±—É–µ–º—ã–º –∞–±–∑–∞—Ü–µ–º."
        )

    if _is_blank(design):
        design_prompt = "–ü—Ä–æ–º–ø—Ç –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –Ω–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω, –ø–æ—Å–∫–æ–ª—å–∫—É –≤ –±—Ä–∏—Ñ–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏."
    else:
        design_prompt = (
            f"–ù–∞–ø–∏—à–∏ –ª–∞–∫–æ–Ω–∏—á–Ω—ã–π –∞–±–∑–∞—Ü –ø—Ä–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –∏–∑ 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π (–Ω–µ –±–æ–ª–µ–µ 2) —Å—É–º–º–∞—Ä–Ω–æ–π –¥–ª–∏–Ω–æ–π "
            f"**—Å—Ç—Ä–æ–≥–æ –Ω–µ –±–æ–ª–µ–µ 300 –∑–Ω–∞–∫–æ–≤ —Å –ø—Ä–æ–±–µ–ª–∞–º–∏** –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ "
            f"–¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞: {name}\n"
            f"{_get_prompt_line('–°—É—Ç—å –ø—Ä–æ–¥—É–∫—Ç–∞', essence)}"
            f"{_get_prompt_line('–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞', design)}"
            "–°—Ç–∏–ª—å ‚Äì –¥–µ–ª–æ–≤–æ–π, –±–µ–∑ –≤–æ—Å–∫–ª–∏—Ü–∞–Ω–∏–π.\n"
            "–ï—Å–ª–∏ –≤ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—É–Ω–∫—Ç–æ–≤, –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑—É–π –Ω—É–º–µ—Ä–∞—Ü–∏—é.\n"
            "–£–±–µ–¥–∏—Å—å, —á—Ç–æ –≤—Å–µ —Ñ–∞–∫—Ç—ã –≤ –æ—Ç–≤–µ—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –∏—Å—Ö–æ–¥–Ω—ã–º –¥–∞–Ω–Ω—ã–º.\n"
            "–ó–∞–≤–µ—Ä—à–∏ —Ñ—Ä–∞–∑–æ–π, —É–∫—Ä–µ–ø–ª—è—é—â–µ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ –≤—ã–≥–æ–¥–Ω–æ—Å—Ç–∏ –ø—Ä–æ–¥—É–∫—Ç–∞.\n"
            "–û—Ç–≤–µ—Ç—å —Ç–æ–ª—å–∫–æ —Ç—Ä–µ–±—É–µ–º—ã–º –∞–±–∑–∞—Ü–µ–º."
        )

    obj_detect = (
        "–ü—Ä–∏–¥—É–º–∞–π 6 —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∫–æ—Ä–æ—Ç–∫–∏—Ö –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–π **—Å—Ç—Ä–æ–≥–æ –Ω–µ –±–æ–ª–µ–µ 5 —Å–ª–æ–≤ –∫–∞–∂–¥–æ–µ**, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–µ—Ç –≤—ã–¥–≤–∏–Ω—É—Ç—å –∫–ª–∏–µ–Ω—Ç, "
        f"–∫–æ–≥–¥–∞ –µ–º—É –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç—Å—è –ø—Ä–∏–æ–±—Ä–µ—Å—Ç–∏ –∏–ª–∏ –æ—Ñ–æ—Ä–º–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –ø—Ä–æ–¥—É–∫—Ç: {name}\n"
        f"{_get_prompt_line('–°—É—Ç—å –ø—Ä–æ–¥—É–∫—Ç–∞', essence)}"
        f"{_get_prompt_line('–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ø—Ä–æ–¥—É–∫—Ç–∞', func)}"
        f"{_get_prompt_line('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∏–∑–Ω–µ—Å–µ –∫–ª–∏–µ–Ω—Ç–∞', biz)}"
        "–û—Ç–≤–µ—Ç—å —Å—Ç—Ä–æ–≥–æ –≤ –≤–∏–¥–µ –Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ –∏–∑ 6 —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∫–æ—Ä–æ—Ç–∫–∏—Ö –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–π."
    )

    return [
        gr.update(value=p, interactive=True)
        for p in [standard_prompt, adv1, adv2, cost_prompt, design_prompt, obj_detect]
    ] + [gr.update(value=p, interactive=True) for p in task_prompts]

def update_prompts(*args):

    return build_all_prompts(*args)

def clear_engagements():

    return [gr.update(value="")] * 2

def update_task_visibility(task_essences_value):

    parsed_tasks = parse_task_essences(task_essences_value) if task_essences_value else []
    num_tasks = len(parsed_tasks) if parsed_tasks else 0

    prompt_row_updates = []
    for i in range(6):

        start_task = i * 3 + 1
        has_tasks = start_task <= num_tasks
        prompt_row_updates.append(gr.update(visible=has_tasks))

    prompt_field_updates = []
    for i in range(18):
        task_num = i + 1
        is_visible = task_num <= num_tasks
        prompt_field_updates.append(gr.update(visible=is_visible))

    result_row_updates = []
    for i in range(18):
        task_num = i + 1
        is_visible = task_num <= num_tasks
        result_row_updates.append(gr.update(visible=is_visible))

    result_field_updates = []
    for i in range(18):
        task_num = i + 1
        is_visible = task_num <= num_tasks
        result_field_updates.append(gr.update(visible=is_visible))

    button_updates = []
    for i in range(18):
        task_num = i + 1
        is_visible = task_num <= num_tasks
        button_updates.append(gr.update(visible=is_visible))

    clarification_updates = []
    for i in range(18):
        task_num = i + 1
        is_visible = task_num <= num_tasks
        clarification_updates.append(gr.update(visible=is_visible))

    return (prompt_row_updates + prompt_field_updates +
            result_row_updates + result_field_updates +
            button_updates + clarification_updates)

def validate_product_name(product_name_val: str):

    if _is_blank(product_name_val):

        raise gr.Warning("–í—ã –Ω–µ —É–∫–∞–∑–∞–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∫—Ä–∏–ø—Ç–∞ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—Å—è –ø–æ –∏–º–µ—é—â–∏–º—Å—è –¥–∞–Ω–Ω—ã–º.")

with gr.Blocks(theme=gr.themes.Default()) as demo:
    with gr.Tabs() as tabs:

        with gr.TabItem("–ë—Ä–∏—Ñ",id=0):
            with gr.Row():
                btn_choose   = gr.Button("–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª (.xlsx)", visible=False)
                btn_template = gr.Button("–°–∫–∞—á–∞—Ç—å —à–∞–±–ª–æ–Ω", visible=False)
            template_holder = gr.File(visible=False)
            file_uploader = gr.File(label="–í—ã–±–µ—Ä–∏—Ç–µ .xlsx", file_types=[".xlsx"], visible=False)

            with gr.Row():
                with gr.Column(scale=1):
                  product_list = gr.Dropdown(
                      [
                          "–°–≤–æ–π –ø—Ä–æ–¥—É–∫—Ç",
                          "–Ækassa",
                          "–ö—É–ø–µ—Ä",
                          "–û–¢–† –ö—É–ø–µ—Ä (—Ç–µ—Å—Ç –û–¢–†)",
                          "–õ–∏–∑–∏–Ω–≥",
                          "–°–±–µ—Ä–ë–∏–∑–Ω–µ—Å –ö–∞—Ä—Ç–∞ Supreme",
                          "–°–±–µ—Ä–õ–∏–¥",
                          "–°–±–µ—Ä–ë–∏–∑–Ω–µ—Å–ë–æ—Ç",
                          "–°–±–µ—Ä–¢–∞—Ä–≥–µ—Ç",
                          "–Æ–î–ë",
			  "–°–±–µ—Ä–ë–∏–∑–Ω–µ—Å–ñ–ö–•"
                      ],
                      value="–°–≤–æ–π –ø—Ä–æ–¥—É–∫—Ç",
                      label="–°–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤",
                      interactive=True
                  )
                with gr.Column(scale=1):
                    product_name = gr.Textbox(label="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞", interactive=True)
                with gr.Column(scale=1):
                    product_essence = gr.Textbox(label="–°—É—Ç—å –ø—Ä–æ–¥—É–∫—Ç–∞", interactive=True)

            boxes = []
            labels = TEMPLATE_ORDER[2:]

            for i in range(0, len(labels), 3):
                with gr.Row():
                    for lbl in labels[i:i+3]:
                        with gr.Column(scale=1):
                            tb = gr.Textbox(label=lbl, interactive=True)
                            boxes.append(tb)

                            if lbl == "–ë–∏–∑–Ω–µ—Å-–ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å":
                                business_need_tb = tb
                            elif lbl == "–°—Ç–æ–∏–º–æ—Å—Ç—å":
                                product_cost_tb = tb
                            elif lbl == "–ö–ª—é—á–µ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ":
                                key_msg_tb = tb
                            elif lbl == "–í—ã–≥–æ–¥–∞ –æ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞":
                                benefit_tb = tb
                            elif lbl == "–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –°–±–µ—Ä–∞ –ø–æ –ø—Ä–æ–¥—É–∫—Ç—É":
                                advantage_tb = tb
                            elif lbl == "–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ø—Ä–æ–¥—É–∫—Ç–∞":
                                func_tb = tb
                            elif lbl == "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∏–∑–Ω–µ—Å–µ –∫–ª–∏–µ–Ω—Ç–∞":
                                biz_info_tb = tb
                            elif lbl == "–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ":
                                design_tb = tb
                            elif lbl == "–°—É—Ç—å –∑–∞–¥–∞—á":
                                task_essences_tb = tb

            boxes.insert(0, product_essence)
            boxes.insert(0, product_name)

            FIELD_BOXES = {
                "–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞": product_name,
                "–°—É—Ç—å –ø—Ä–æ–¥—É–∫—Ç–∞":     product_essence,
            }
            for lbl, tb in zip(labels, boxes[2:]):
                FIELD_BOXES[lbl] = tb

            btn_to_prompts = gr.Button("–ü–µ—Ä–µ–π—Ç–∏ –∫ –ø—Ä–æ–º–ø—Ç–∞–º –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞")

        with gr.TabItem("–ü—Ä–æ–º–ø—Ç—ã", id=1):

            task_prompt_rows = []
            task_prompts = []
            for i in range(0, 18, 3):
                row = gr.Row(visible=False)
                task_prompt_rows.append(row)
                with row:
                    for j in range(3):
                        if i + j + 1 <= 18:
                            prompt_box = gr.Textbox(
                                label=f"–ü—Ä–æ–º–ø—Ç –¥–ª—è –≤–æ–≤–ª–µ—á–µ–Ω–∏—è (—Å—É—Ç—å –∑–∞–¥–∞—á–∏ {i + j + 1})",
                                lines=33,
                                visible=False
                            )
                            task_prompts.append(prompt_box)

            with gr.Row():
                prompt_eng_standard = gr.Textbox(
                    label="–ü—Ä–æ–º–ø—Ç –¥–ª—è –≤–æ–≤–ª–µ—á–µ–Ω–∏—è (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π)",
                    lines=22
                )

            with gr.Row():
                generate_engagements_btn = gr.Button("–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤–æ–≤–ª–µ—á–µ–Ω–∏—è")

            with gr.Row():
                prompt_adv1 = gr.Textbox(
                    label="–ü—Ä–æ–º–ø—Ç –¥–ª—è –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤ 1",
                    lines=30,
                    interactive=False
                )
                prompt_adv2 = gr.Textbox(
                    label="–ü—Ä–æ–º–ø—Ç –¥–ª—è –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤ 2",
                    lines=30,
                    interactive=False
                )

            with gr.Row():
                prompt_cost = gr.Textbox(
                    label="–ü—Ä–æ–º–ø—Ç –¥–ª—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏",
                    lines=12,
                    interactive=False
                )
                prompt_format = gr.Textbox(
                    label="–ü—Ä–æ–º–ø—Ç –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è",
                    lines=12,
                    interactive=False
                )

            with gr.Row():
                prompt_obj_detect = gr.Textbox(
                    label="–ü—Ä–æ–º–ø—Ç –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è 6 –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–π",
                    lines=20, scale=3, interactive=False
                )

            eng_inputs = [
                product_list,
                product_name,
                product_essence,
                task_essences_tb,
                key_msg_tb,
                benefit_tb,
                advantage_tb,
                product_cost_tb,
                design_tb,
                func_tb,
                biz_info_tb,
            ]

            for src in eng_inputs:
                src.change(
                    update_prompts,
                    inputs=eng_inputs,
                    outputs=[
                        prompt_eng_standard,
                        prompt_adv1, prompt_adv2,
                        prompt_cost, prompt_format,
                        prompt_obj_detect,
                    ] + task_prompts,
                )

            task_essences_tb.change(
                lambda x: update_task_visibility(x)[:24],
                inputs=task_essences_tb,
                outputs=task_prompt_rows + task_prompts,
            )

            with gr.Row(visible=False):
                prompt_obj_llm1 = gr.Textbox(
                    label="–ü—Ä–æ–º–ø—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–µ–º LLM 1",
                    lines=40,
                    interactive=False,
                )
                prompt_obj_llm2 = gr.Textbox(
                    label="–ü—Ä–æ–º–ø—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–µ–º LLM 2",
                    lines=40,
                    interactive=False,
                )
                prompt_obj_llm3 = gr.Textbox(
                    label="–ü—Ä–æ–º–ø—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–µ–º LLM 3",
                    lines=40,
                    interactive=False,
                )

            with gr.Row(visible=False):
                prompt_obj_llm4 = gr.Textbox(
                    label="–ü—Ä–æ–º–ø—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–µ–º LLM 4",
                    lines=40,
                    interactive=False,
                )
                prompt_obj_llm5 = gr.Textbox(
                    label="–ü—Ä–æ–º–ø—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–µ–º LLM 5",
                    lines=40,
                    interactive=False,
                )
                prompt_obj_llm6 = gr.Textbox(
                    label="–ü—Ä–æ–º–ø—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–µ–º LLM 6",
                    lines=40,
                    interactive=False,
                )

            LLM_PROMPT_BOXES = [
                prompt_obj_llm1, prompt_obj_llm2, prompt_obj_llm3,
                prompt_obj_llm4, prompt_obj_llm5, prompt_obj_llm6,
            ]

            llm = gr.Dropdown(
                ["GigaChat-2-Max", "GigaChat-2-Pro", "GigaChat-Max (–¥–æ 1 –∏—é–ª—è)",
                 "ChatGPT-4o"],
                value="GigaChat-2-Max",
                label="–í—ã–±—Ä–∞—Ç—å LLM",
                interactive=True
            )
            btn_to_script = gr.Button("–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Å–∫—Ä–∏–ø—Ç")

        with gr.TabItem("–°–∫—Ä–∏–ø—Ç", id=2):
            frozen = {
            }

            script_boxes = {}
            eng_boxes = {}
            clar_boxes = {}

            task_result_rows = []
            task_result_boxes = []
            task_result_buttons = []
            task_result_clarifications = []

            for i in range(1, 19):
                with gr.Row(visible=False) as row:
                    task_result_rows.append(row)
                    sec_name = f"–í–æ–≤–ª–µ—á–µ–Ω–∏–µ (—Å—É—Ç—å –∑–∞–¥–∞—á–∏ {i})"

                    with gr.Column(scale=1):
                        sbox = gr.Textbox(
                            label=sec_name,
                            lines=11,
                            interactive=True,
                            visible=False
                        )
                        task_result_boxes.append(sbox)
                        eng_boxes[sec_name] = sbox

                    with gr.Column(scale=1):
                        regen = gr.Button(
                            "–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å",
                            variant="secondary",
                            interactive=True,
                            visible=False
                        )
                        task_result_buttons.append(regen)

                    with gr.Column(scale=1):
                        clar = gr.Textbox(
                            label="–£—Ç–æ—á–Ω—è—é—â–∏–π –ø—Ä–æ–º–ø—Ç",
                            lines=11,
                            interactive=True,
                            visible=False
                        )
                        task_result_clarifications.append(clar)
                        clar_boxes[sec_name] = clar

            task_essences_tb.change(
                lambda x: update_task_visibility(x)[24:],
                inputs=task_essences_tb,
                outputs=(task_result_rows + task_result_boxes +
                        task_result_buttons + task_result_clarifications),
            )

            REGEN_BUTTONS = {}
            OBJ_ROWS = {}

            HIDDEN_PROMPT_BOXES = {}

            for i, regen in enumerate(task_result_buttons):
                task_num = i + 1
                sec_name = f"–í–æ–≤–ª–µ—á–µ–Ω–∏–µ (—Å—É—Ç—å –∑–∞–¥–∞—á–∏ {task_num})"
                REGEN_BUTTONS[sec_name] = regen

            for sec in SCRIPT_SECTIONS:
                locked = sec in frozen
                is_obj = sec.startswith("–í–æ–∑—Ä–∞–∂–µ–Ω–∏–µ")
                obj_num = int(sec.split()[1]) if is_obj else 0

                default_visible = (not is_obj) or (obj_num <= 6)
                with gr.Row(visible=default_visible) as row:

                    with gr.Column(scale=1):
                        sbox = gr.Textbox(
                            label=sec,
                            lines=11,
                            value=(""
                                   if locked else ""),
                            interactive=not locked,
                        )
                        script_boxes[sec] = sbox

                    if sec.startswith("–í–æ–≤–ª–µ—á–µ–Ω–∏–µ"):
                        eng_boxes[sec] = sbox

                    with gr.Column(scale=1):
                        regen = gr.Button(
                            "–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å",
                            variant="secondary",
                            interactive=not locked,
                        )
                        REGEN_BUTTONS[sec] = regen

                    with gr.Column(scale=1):
                        clar = gr.Textbox(
                            label="–£—Ç–æ—á–Ω—è—é—â–∏–π –ø—Ä–æ–º–ø—Ç",
                            lines=11,
                            interactive=not locked,
                        )

                    clar_boxes[sec] = clar

                    if is_obj:
                        HIDDEN_PROMPT_BOXES[sec] = gr.Textbox(visible=False)

                if is_obj:
                    OBJ_ROWS[sec] = row

            PROMPT_MAP = {
                "–í–æ–≤–ª–µ—á–µ–Ω–∏–µ 1":  prompt_eng_standard,
                "–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ 1": prompt_adv1,
                "–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ 2": prompt_adv2,
                "–°—Ç–æ–∏–º–æ—Å—Ç—å":      prompt_cost,
                "–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ":     prompt_format,
            }

            for i in range(18):
                task_num = i + 1
                sec_name = f"–í–æ–≤–ª–µ—á–µ–Ω–∏–µ (—Å—É—Ç—å –∑–∞–¥–∞—á–∏ {task_num})"
                PROMPT_MAP[sec_name] = task_prompts[i]

            for sec in (
                "–í–æ–≤–ª–µ—á–µ–Ω–∏–µ 1",
                "–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ 1", "–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ 2", "–°—Ç–æ–∏–º–æ—Å—Ç—å", "–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ"
            ):
                REGEN_BUTTONS[sec].click(
                    refine_section,
                    inputs=[
                        llm,
                        PROMPT_MAP[sec],
                        script_boxes[sec],
                        clar_boxes[sec],

                        product_essence, key_msg_tb, benefit_tb,
                        advantage_tb, product_cost_tb, design_tb,
                        func_tb, biz_info_tb
                    ],
                    outputs=[script_boxes[sec], clar_boxes[sec]],
                    queue=True
                )

            for i in range(18):
                task_num = i + 1
                sec_name = f"–í–æ–≤–ª–µ—á–µ–Ω–∏–µ (—Å—É—Ç—å –∑–∞–¥–∞—á–∏ {task_num})"
                if sec_name in REGEN_BUTTONS:
                    REGEN_BUTTONS[sec_name].click(
                        refine_section,
                        inputs=[
                            llm,
                            PROMPT_MAP[sec_name],
                            eng_boxes[sec_name],
                            clar_boxes[sec_name],

                            product_essence, task_essences_tb, key_msg_tb, benefit_tb,
                            advantage_tb, product_cost_tb, design_tb,
                            func_tb, biz_info_tb
                        ],
                        outputs=[eng_boxes[sec_name], clar_boxes[sec_name]],
                        queue=True
                    )

            for i in range(1, MAX_OBJS+1):
                sec = f"–í–æ–∑—Ä–∞–∂–µ–Ω–∏–µ {i}"
                REGEN_BUTTONS[sec].click(
                    refine_llm_objection,
                    inputs=[
                        llm,
                        HIDDEN_PROMPT_BOXES[sec],
                        script_boxes[sec],
                        clar_boxes[sec],
                    ],
                    outputs=[script_boxes[sec], clar_boxes[sec]],
                    queue=True
                )

            with gr.Row():

                with gr.Column(scale=1):
                    btn_export  = gr.Button("–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∫—Ä–∏–ø—Ç (.xlsx)")
                    file_export = gr.File(visible=False)

                with gr.Column(scale=1):
                    btn_export_json  = gr.Button("–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∫—Ä–∏–ø—Ç (.json)")
                    file_export_json = gr.File(visible=False)

        with gr.TabItem("–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å", id=3):
            feedback_box = gr.Textbox(
                label="–ö–Ω–∏–≥–∞ –∂–∞–ª–æ–± –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –ø–æ –ø—Ä–æ–≥—Ä–∞–º–º–µ",
                lines=8
            )
            submit_feedback = gr.Button("–û—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π")

        with gr.TabItem("Changelog", id=4):
            gr.Markdown("""
            **24.07.2025. Voice_Script_v1.0.**
            """)

        with gr.TabItem("–°—Ö–µ–º–∞", id=5):
            scheme_img = gr.Image(
                value=gh_image("scheme.png"),
                label="–°—Ö–µ–º–∞",
                interactive=False,
            )

        with gr.TabItem("–°–±–æ—Ä", id=6):
            gr.Markdown("**–î–∞–Ω–Ω–∞—è –≤–∫–ª–∞–¥–∫–∞ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–±–æ—Ä–∞ —ç—Ç–∞–ª–æ–Ω–Ω—ã—Ö –≤–æ–≤–ª–µ—á–µ–Ω–∏–π**")

            url_input = gr.Textbox(
                label="–°—Å—ã–ª–∫–∞",
                placeholder="–í—Å—Ç–∞–≤—å—Ç–µ URL-—Å—Å—ã–ª–∫—É",
                interactive=True
            )

            with gr.Row():
                parse_btn = gr.Button("–ü–∞—Ä—Å–∏—Ç—å")
                gr.Markdown("‚ö†Ô∏è *–í —Å–ª—É—á–∞–µ –Ω–µ—É—Å–ø–µ—à–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫–∞–∫–æ–π-–ª–∏–±–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ—Å—Ç–∞–≤—å—Ç–µ –æ–± —ç—Ç–æ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–∞ –≤–∫–ª–∞–¥–∫–µ ¬´–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å¬ª –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –ê–∫–∏–º–æ–≤—ã–º –î. ‚Äì –∫–µ–π—Å –±—É–¥–µ—Ç –∏–∑—É—á–µ–Ω, –∞–ª–≥–æ—Ä–∏—Ç–º—ã –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω—ã*")

            page_content = gr.Textbox(
                label="–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã",
                lines=10,
                interactive=True
            )

            with gr.Row():
                prompt_expert = gr.Textbox(
                    label="–ü—Ä–æ–º–ø—Ç \"–Ø —ç–∫—Å–ø–µ—Ä—Ç\"",
                    lines=5,
                    interactive=True
                )
                prompt_problem = gr.Textbox(
                    label="–ü—Ä–æ–º–ø—Ç \"–ß–µ—Ä–µ–∑ –ø—Ä–æ–±–ª–µ–º—É\"",
                    lines=5,
                    interactive=True
                )
                prompt_care = gr.Textbox(
                    label="–ü—Ä–æ–º–ø—Ç \"–ß–µ—Ä–µ–∑ –∑–∞–±–æ—Ç—É\"",
                    lines=5,
                    interactive=True
                )
                prompt_questions = gr.Textbox(
                    label="–ü—Ä–æ–º–ø—Ç \"–ß–µ—Ä–µ–∑ –≤–æ–ø—Ä–æ—Å—ã\"",
                    lines=5,
                    interactive=True
                )

            model_dropdown = gr.Dropdown(
                choices=[
                    "GPT-4o",
                    "GigaChat-2-Max",
                    "GPT-5",
                    "Gemini-2.5 Pro",
                    "Gemini-2.5 Flash",
                    "Claude Opus 4.1",
                    "Grok 4",
                    "GLM 4.5",
                    "DeepSeek-R1",
                    "DeepSeek-V3.1",
                    "Kimi-K2",
                    "Qwen3-235B"
                ],
                value="GPT-4o",
                label="–ú–æ–¥–µ–ª—å",
                interactive=True
            )

            generate_all_btn = gr.Button("–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –≤–æ–≤–ª–µ—á–µ–Ω–∏—è")

            with gr.Row():
                generate_btn_1 = gr.Button("–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å")
                generate_btn_2 = gr.Button("–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å")
                generate_btn_3 = gr.Button("–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å")
                generate_btn_4 = gr.Button("–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å")

            with gr.Row():
                engagement_expert = gr.Textbox(
                    label="–í–æ–≤–ª–µ—á–µ–Ω–∏–µ \"–Ø —ç–∫—Å–ø–µ—Ä—Ç\"",
                    lines=5,
                    interactive=True
                )
                engagement_problem = gr.Textbox(
                    label="–í–æ–≤–ª–µ—á–µ–Ω–∏–µ \"–ß–µ—Ä–µ–∑ –ø—Ä–æ–±–ª–µ–º—É\"",
                    lines=5,
                    interactive=True
                )
                engagement_care = gr.Textbox(
                    label="–í–æ–≤–ª–µ—á–µ–Ω–∏–µ \"–ß–µ—Ä–µ–∑ –∑–∞–±–æ—Ç—É\"",
                    lines=5,
                    interactive=True
                )
                engagement_questions = gr.Textbox(
                    label="–í–æ–≤–ª–µ—á–µ–Ω–∏–µ \"–ß–µ—Ä–µ–∑ –≤–æ–ø—Ä–æ—Å—ã\"",
                    lines=5,
                    interactive=True
                )

            with gr.Row():
                comment_1 = gr.Textbox(
                    label="–£—Ç–æ—á–Ω—è—é—â–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π",
                    lines=3,
                    interactive=True
                )
                comment_2 = gr.Textbox(
                    label="–£—Ç–æ—á–Ω—è—é—â–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π",
                    lines=3,
                    interactive=True
                )
                comment_3 = gr.Textbox(
                    label="–£—Ç–æ—á–Ω—è—é—â–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π",
                    lines=3,
                    interactive=True
                )
                comment_4 = gr.Textbox(
                    label="–£—Ç–æ—á–Ω—è—é—â–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π",
                    lines=3,
                    interactive=True
                )

            with gr.Row():
                regen_btn_1 = gr.Button("–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å", variant="secondary")
                regen_btn_2 = gr.Button("–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å", variant="secondary")
                regen_btn_3 = gr.Button("–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å", variant="secondary")
                regen_btn_4 = gr.Button("–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å", variant="secondary")

    _openrouter = os.getenv("OPENROUTER_API_KEY")
    _gpt5_key = os.getenv("OPENAI_GPT5_API_KEY")

    additional_models = {

        "Gemini-2.5 Pro": lambda: OpenAI(
            base_url="https://openrouter.ai/api/v1",
            api_key=_openrouter
        ),
        "Gemini-2.5 Flash": lambda: OpenAI(
            base_url="https://openrouter.ai/api/v1",
            api_key=_openrouter
        ),
        "Claude Opus 4.1": lambda: OpenAI(
            base_url="https://openrouter.ai/api/v1",
            api_key=_openrouter
        ),
        "Grok 4": lambda: OpenAI(
            base_url="https://openrouter.ai/api/v1",
            api_key=_openrouter
        ),
        "GLM 4.5": lambda: OpenAI(
            base_url="https://openrouter.ai/api/v1",
            api_key=_openrouter
        ),

        "GPT-4o": lambda: ChatOpenAI(api_key=_openai, model="gpt-4o"),
        "GPT-5": lambda: ChatOpenAI(api_key=_gpt5_key, model="gpt-5"),
        "DeepSeek-V3.1": lambda: ChatTogether(api_key=_together, model="deepseek-ai/DeepSeek-V3.1"),
        "DeepSeek-R1": lambda: ChatTogether(api_key=_together, model="deepseek-ai/DeepSeek-R1"),
        "Kimi-K2": lambda: ChatTogether(api_key=_together, model="moonshotai/Kimi-K2-Instruct-0905"),
        "Qwen3-235B": lambda: ChatTogether(api_key=_together, model="Qwen/Qwen3-235B-A22B-Instruct-2507-tput"),
    }

    chat_pool.update(additional_models)

    def generate_engagement(model_name, prompt):

        try:

            if model_name in ["Gemini-2.5 Pro", "Gemini-2.5 Flash", "Claude Opus 4.1", "Grok 4", "GLM 4.5"]:
                model_mapping = {
                    "Gemini-2.5 Pro": "google/gemini-2.5-pro",
                    "Gemini-2.5 Flash": "google/gemini-2.5-flash",
                    "Claude Opus 4.1": "anthropic/claude-opus-4.1",
                    "Grok 4": "x-ai/grok-4",
                    "GLM 4.5": "z-ai/glm-4.5"
                }

                if model_name not in chat_pool:
                    return f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –º–æ–¥–µ–ª—å: {model_name}"

                client = chat_pool[model_name]
                if not hasattr(client, "chat"):
                    client = client()
                    chat_pool[model_name] = client

                completion = client.chat.completions.create(
                    extra_headers={
                        "HTTP-Referer": "https://railway.app",
                        "X-Title": "Voice Script Generator"
                    },
                    model=model_mapping[model_name],
                    messages=[{"role": "user", "content": prompt}],
                    temperature=0.7
                )
                result = completion.choices[0].message.content
            else:

                result = call_llm(model_name, prompt)

            if model_name == "DeepSeek-R1" and result:
                result = clean_response(result)

            if result:
                result = result.strip()

            return result

        except Exception as e:
            return f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {str(e)}"

    def generate_prompts(page_content):

        if not page_content or not page_content.strip():
            return "", "", "", ""

        base_template = """–ù–∞–ø–∏—à–∏ –ø—Ä–µ–¥–µ–ª—å–Ω–æ –≤–æ–≤–ª–µ–∫–∞—é—â–∏–π –∏ –ª–∞–∫–æ–Ω–∏—á–Ω—ã–π –∞–±–∑–∞—Ü –∏–∑ 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π (–Ω–µ –±–æ–ª–µ–µ 4) —Å—É–º–º–∞—Ä–Ω–æ–π –¥–ª–∏–Ω–æ–π —Å—Ç—Ä–æ–≥–æ –Ω–µ –±–æ–ª–µ–µ 300 –∑–Ω–∞–∫–æ–≤ —Å –ø—Ä–æ–±–µ–ª–∞–º–∏ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞:

"{content}"

–í—ã–±–µ—Ä–∏ –¢–û–õ–¨–ö–û –°–ê–ú–£–Æ –í–ê–ñ–ù–£–Æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –∞–±–∑–∞—Ü–∞. –ö–∞–∂–¥–æ–µ —Å–ª–æ–≤–æ –Ω–∞ —Å—á–µ—Ç—É. –ù–ò –í –ö–û–ï–ú –°–õ–£–ß–ê–ï –Ω–µ –¥–æ–±–∞–≤–ª—è–π —Ñ–∞–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

–°–Ω–∞—á–∞–ª–∞ –æ—Ç—Ñ–∏–ª—å—Ç—Ä—É–π –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—Å—Ç—Ä–æ–≥–æ):
‚Äî –û–ø—Ä–µ–¥–µ–ª–∏ –≥–ª–∞–≤–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç/—Å–µ—Ä–≤–∏—Å –∏ –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —Ñ–∞–∫—Ç—ã –∏–∑ –µ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è, —Å–≤–æ–π—Å—Ç–≤ –∏ –±–ª–æ–∫–∞ ¬´–∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å¬ª.
‚Äî –ò–≥–Ω–æ—Ä–∏—Ä—É–π –æ–±—â–µ—Å–∞–π—Ç–æ–≤—ã–µ/—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã: –±–∞–Ω–Ω–µ—Ä—ã (–Ω–∞–ø—Ä., –ø—Ä–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –ù–£–¶ –ú–∏–Ω—Ü–∏—Ñ—Ä—ã), –º–µ–Ω—é, –∫–Ω–æ–ø–∫–∏ (¬´–ü–æ–¥—Ä–æ–±–Ω–µ–µ¬ª, ¬´–û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É¬ª, ¬´–ü–µ—Ä–µ–π—Ç–∏‚Ä¶¬ª), —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏, –∞—Ä—Ö–∏–≤—ã, —Å—á—ë—Ç—á–∏–∫–∏/–≤—Ä–µ–º—è —á—Ç–µ–Ω–∏—è, —Å—Å—ã–ª–∫–∏ –∏ –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ —Ä–∞–∑–¥–µ–ª—ã.
‚Äî –ï—Å–ª–∏ —É–ø–æ–º—è–Ω—É—Ç–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—É—â–Ω–æ—Å—Ç–µ–π, –≤—ã–±–µ—Ä–∏ —Ç—É, —á—Ç–æ –∏–º–µ–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ –∏ –æ–ø–∏—Å–∞–Ω–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è."""

        expert_prompt = base_template + """

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∞–±–∑–∞—Ü–∞ (—Å—Ç—Ä–æ–≥–æ —Å–æ–±–ª—é–¥–∞–π):
1. –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ 1 ‚Äî —Å–∞–º–æ–ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö: –∫—Ä–∞—Ç–∫–æ –æ–±–æ–∑–Ω–∞—á—å —Ä–æ–ª—å/–∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏—é –∏–ª–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é –ø–æ–ª—å–∑—É –¥–ª—è –∞—É–¥–∏—Ç–æ—Ä–∏–∏; –¥–æ–ø—É—Å—Ç–∏–º–∞ —Å–∞–º–æ–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è (¬´–Ø —ç–∫—Å–ø–µ—Ä—Ç –ø–æ [—Ç–µ–º–∞]¬ª) –∏–ª–∏ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (¬´–†–µ—à–µ–Ω–∏–µ –ø–æ–º–æ–≥–∞–µ—Ç‚Ä¶¬ª). –¢–æ–ª—å–∫–æ —Ñ–∞–∫—Ç—ã, –±–µ–∑ –æ—Ü–µ–Ω–æ—á–Ω—ã—Ö —Å–ª–æ–≤.
2. –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ 2 ‚Äî —Å–≤—è–∂–∏ –ø—Ä–æ–¥—É–∫—Ç —Å —Ä–µ—à–µ–Ω–∏–µ–º: –æ–¥–∏–Ω —Ñ–∞–∫—Ç/–º–µ—Ö–∞–Ω–∏–∫–∞/—Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–∑ –¥–∞–Ω–Ω—ã—Ö, –±–µ–∑ –æ—Ü–µ–Ω–æ—á–Ω—ã—Ö —Å–ª–æ–≤ –∏ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–π.
3. –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ 3 ‚Äî –æ–¥–∏–Ω –∫–æ—Ä–æ—Ç–∫–∏–π –≤–æ–ø—Ä–æ—Å –æ —Ç–µ–∫—É—â–µ–º –ø—Ä–æ—Ü–µ—Å—Å–µ/–±–æ–ª–∏ –∫–ª–∏–µ–Ω—Ç–∞, —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–∑ –≥–ª–∞–≤–Ω–æ–π –∑–∞–¥–∞—á–∏ (–Ω–∞–ø—Ä.: ¬´–ö–∞–∫ –≤—ã —Å–µ–π—á–∞—Å [–¥–µ–π—Å—Ç–≤–∏–µ]?¬ª, ¬´–ß—Ç–æ –º–µ—à–∞–µ—Ç [—Ü–µ–ª—å]?¬ª. –ï—Å–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ 2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π, –æ–±—ä–µ–¥–∏–Ω–∏ 1) –∏ 2), –∞ –≤–æ–ø—Ä–æ—Å —Å–¥–µ–ª–∞–π –≤—Ç–æ—Ä—ã–º.

–°—Ç–∏–ª—å ‚Äì –¥–µ–ª–æ–≤–æ–π, –±–µ–∑ –≤–æ—Å–∫–ª–∏—Ü–∞–Ω–∏–π.
–£–±–µ–¥–∏—Å—å, —á—Ç–æ –≤—Å–µ —Ñ–∞–∫—Ç—ã –≤ –æ—Ç–≤–µ—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –∏—Å—Ö–æ–¥–Ω—ã–º –¥–∞–Ω–Ω—ã–º.
–û—Ç–≤–µ—Ç—å —Ç–æ–ª—å–∫–æ —Ç—Ä–µ–±—É–µ–º—ã–º –∞–±–∑–∞—Ü–µ–º."""

        problem_prompt = base_template + """

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∞–±–∑–∞—Ü–∞ (—Å—Ç—Ä–æ–≥–æ —Å–æ–±–ª—é–¥–∞–π):
1. –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ 1 ‚Äî –∑–∞–¥–∞–π –ø—Ä–æ–±–ª–µ–º—É –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö: —Å–∂–∞—Ç–æ –∏ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ –æ–ø–∏—à–∏ –∫–ª—é—á–µ–≤—É—é —Ç—Ä—É–¥–Ω–æ—Å—Ç—å –∞—É–¥–∏—Ç–æ—Ä–∏–∏ –∏ –±–∞—Ä—å–µ—Ä/–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∏–∑ –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –±–µ–∑ –ø—Ä–µ—É–≤–µ–ª–∏—á–µ–Ω–∏–π –∏ –¥–æ–º—ã—Å–ª–æ–≤; —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–∞—è, —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∞—è.
2. –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ 2 ‚Äî —Å–≤—è–∂–∏ –ø—Ä–æ–¥—É–∫—Ç —Å —Ä–µ—à–µ–Ω–∏–µ–º: –æ–¥–∏–Ω —Ñ–∞–∫—Ç/–º–µ—Ö–∞–Ω–∏–∫–∞/—Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–∑ –¥–∞–Ω–Ω—ã—Ö, –±–µ–∑ –æ—Ü–µ–Ω–æ—á–Ω—ã—Ö —Å–ª–æ–≤ –∏ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–π.
3. –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ 3 ‚Äî –æ–¥–∏–Ω –∫–æ—Ä–æ—Ç–∫–∏–π –≤–æ–ø—Ä–æ—Å –æ —Ç–µ–∫—É—â–µ–º –ø—Ä–æ—Ü–µ—Å—Å–µ/–±–æ–ª–∏ –∫–ª–∏–µ–Ω—Ç–∞, —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–∑ –≥–ª–∞–≤–Ω–æ–π –∑–∞–¥–∞—á–∏ (–Ω–∞–ø—Ä.: ¬´–ö–∞–∫ –≤—ã —Å–µ–π—á–∞—Å [–¥–µ–π—Å—Ç–≤–∏–µ]?¬ª, ¬´–ß—Ç–æ –º–µ—à–∞–µ—Ç [—Ü–µ–ª—å]?¬ª. –ï—Å–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ 2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π, –æ–±—ä–µ–¥–∏–Ω–∏ 1) –∏ 2), –∞ –≤–æ–ø—Ä–æ—Å —Å–¥–µ–ª–∞–π –≤—Ç–æ—Ä—ã–º.

–°—Ç–∏–ª—å ‚Äì –¥–µ–ª–æ–≤–æ–π, –±–µ–∑ –≤–æ—Å–∫–ª–∏—Ü–∞–Ω–∏–π.
–£–±–µ–¥–∏—Å—å, —á—Ç–æ –≤—Å–µ —Ñ–∞–∫—Ç—ã –≤ –æ—Ç–≤–µ—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –∏—Å—Ö–æ–¥–Ω—ã–º –¥–∞–Ω–Ω—ã–º.
–û—Ç–≤–µ—Ç—å —Ç–æ–ª—å–∫–æ —Ç—Ä–µ–±—É–µ–º—ã–º –∞–±–∑–∞—Ü–µ–º."""

        care_prompt = base_template + """

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∞–±–∑–∞—Ü–∞ (—Å—Ç—Ä–æ–≥–æ —Å–æ–±–ª—é–¥–∞–π):
1. –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ 1 ‚Äî —Å—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –∑–∞–±–æ—Ç—É: ¬´–ß—Ç–æ–±—ã [–∞—É–¥–∏—Ç–æ—Ä–∏–∏] –±—ã–ª–æ –ø—Ä–æ—â–µ/–±—ã—Å—Ç—Ä–µ–µ/–±–µ–∑–æ–ø–∞—Å–Ω–µ–µ [–∫–ª—é—á–µ–≤–∞—è –∑–∞–¥–∞—á–∞], [–ø—Ä–æ–¥—É–∫—Ç] –ø–æ–º–æ–≥–∞–µ—Ç [1‚Äì2 —Å–∞–º—ã—Ö –≤–∞–∂–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏—è/–≤—ã–≥–æ–¥—ã –∏–∑ –¥–∞–Ω–Ω—ã—Ö]¬ª.
2. –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ 2 ‚Äî –æ–¥–∏–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ñ–∞–∫—Ç/—Ñ—É–Ω–∫—Ü–∏—è/—Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–∑ –¥–∞–Ω–Ω—ã—Ö, –ø–æ–∫–∞–∑—ã–≤–∞—é—â–∏–π, –∫–∞–∫ –ø—Ä–æ–¥—É–∫—Ç —Å–Ω–∏–º–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É –∏–ª–∏ —ç–∫–æ–Ω–æ–º–∏—Ç –≤—Ä–µ–º—è; –±–µ–∑ –æ—Ü–µ–Ω–æ–∫ –∏ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–π.
3. –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ 3 ‚Äî –æ–¥–∏–Ω –∫–æ—Ä–æ—Ç–∫–∏–π –≤–æ–ø—Ä–æ—Å –æ —Ç–µ–∫—É—â–µ–º –ø—Ä–æ—Ü–µ—Å—Å–µ/–±–æ–ª–∏ –∫–ª–∏–µ–Ω—Ç–∞ (–Ω–∞–ø—Ä.: ¬´–ö–∞–∫ –≤—ã —Å–µ–π—á–∞—Å [–¥–µ–π—Å—Ç–≤–∏–µ]?¬ª, ¬´–ì–¥–µ —Ç—Ä–∞—Ç–∏—Ç–µ –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏?¬ª). –ï—Å–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ 2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π, –æ–±—ä–µ–¥–∏–Ω–∏ 1) –∏ 2), –∞ –≤–æ–ø—Ä–æ—Å —Å–¥–µ–ª–∞–π –≤—Ç–æ—Ä—ã–º.

–°—Ç–∏–ª—å ‚Äì –¥–µ–ª–æ–≤–æ–π, –±–µ–∑ –≤–æ—Å–∫–ª–∏—Ü–∞–Ω–∏–π.
–£–±–µ–¥–∏—Å—å, —á—Ç–æ –≤—Å–µ —Ñ–∞–∫—Ç—ã –≤ –æ—Ç–≤–µ—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –∏—Å—Ö–æ–¥–Ω—ã–º –¥–∞–Ω–Ω—ã–º.
–û—Ç–≤–µ—Ç—å —Ç–æ–ª—å–∫–æ —Ç—Ä–µ–±—É–µ–º—ã–º –∞–±–∑–∞—Ü–µ–º."""

        questions_prompt = base_template + """

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∞–±–∑–∞—Ü–∞ (—Å—Ç—Ä–æ–≥–æ —Å–æ–±–ª—é–¥–∞–π):
1. –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ 1 ‚Äî –∫–æ—Ä–æ—Ç–∫–∏–π —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å –æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏: ¬´–í—ã [–∞—É–¥–∏—Ç–æ—Ä–∏—è/—Ä–æ–ª—å –∏–∑ –¥–∞–Ω–Ω—ã—Ö] –≤ [–æ–±–ª–∞—Å—Ç—å –ø—Ä–æ–¥—É–∫—Ç–∞]?¬ª –∏–ª–∏ ¬´–†–∞–±–æ—Ç–∞–µ—Ç–µ —Å [–∑–∞–¥–∞—á–∞/–ø—Ä–æ—Ü–µ—Å—Å –∏–∑ –¥–∞–Ω–Ω—ã—Ö]?¬ª (—Ç–æ–ª—å–∫–æ —Ç–µ—Ä–º–∏–Ω—ã –∏–∑ –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö).
2. –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ 2 ‚Äî –≤–æ–ø—Ä–æ—Å –æ –≥–ª–∞–≤–Ω–æ–π –±–æ–ª–∏/–∑–∞–¥–∞—á–µ: ¬´–ß—Ç–æ —Å–ª–æ–∂–Ω–µ–µ –≤—Å–µ–≥–æ –≤ [–∫–ª—é—á–µ–≤–∞—è –∑–∞–¥–∞—á–∞ –∏–∑ –¥–∞–Ω–Ω—ã—Ö]?¬ª, ¬´–ö–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ —Å–µ–π—á–∞—Å –æ—Å–æ–±–µ–Ω–Ω–æ –æ—Å—Ç—Ä–æ?¬ª –∏–ª–∏ ¬´–ö–∞–∫ –≤—ã —Å–µ–π—á–∞—Å [–¥–µ–π—Å—Ç–≤–∏–µ/–ø—Ä–æ—Ü–µ—Å—Å –∏–∑ –¥–∞–Ω–Ω—ã—Ö]?¬ª ‚Äî –æ–¥–∏–Ω —Ñ–æ–∫—É—Å.
3. –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ 3 (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) ‚Äî –≤–æ–ø—Ä–æ—Å –æ –∫—Ä–∏—Ç–µ—Ä–∏–∏/–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–µ, —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å —Ü–µ–Ω–Ω–æ—Å—Ç—å—é –ø—Ä–æ–¥—É–∫—Ç–∞ –∏–∑ –¥–∞–Ω–Ω—ã—Ö: ¬´–ß—Ç–æ –¥–ª—è –≤–∞—Å –≤–∞–∂–Ω–µ–µ –≤ [–ø—Ä–æ—Ü–µ—Å—Å/—Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–∑ –¥–∞–Ω–Ω—ã—Ö]?¬ª –∏–ª–∏ ¬´–ü–æ –∫–∞–∫–æ–º—É –∫—Ä–∏—Ç–µ—Ä–∏—é –≤—ã–±–∏—Ä–∞–µ—Ç–µ [—Ç–∏–ø —Ä–µ—à–µ–Ω–∏—è –∏–∑ –¥–∞–Ω–Ω—ã—Ö]?¬ª.

–°—Ç–∏–ª—å ‚Äì –¥–µ–ª–æ–≤–æ–π, –±–µ–∑ –≤–æ—Å–∫–ª–∏—Ü–∞–Ω–∏–π.
–£–±–µ–¥–∏—Å—å, —á—Ç–æ –≤—Å–µ —Ñ–∞–∫—Ç—ã –≤ –æ—Ç–≤–µ—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –∏—Å—Ö–æ–¥–Ω—ã–º –¥–∞–Ω–Ω—ã–º.
–û—Ç–≤–µ—Ç—å —Ç–æ–ª—å–∫–æ —Ç—Ä–µ–±—É–µ–º—ã–º –∞–±–∑–∞—Ü–µ–º."""

        return (
            expert_prompt.format(content=page_content),
            problem_prompt.format(content=page_content),
            care_prompt.format(content=page_content),
            questions_prompt.format(content=page_content)
        )

    def generate_single_engagement(model_name, prompt_text, engagement_type):

        if not prompt_text or not prompt_text.strip():
            return f"–û—à–∏–±–∫–∞: –ü—Ä–æ–º–ø—Ç –¥–ª—è '{engagement_type}' –ø—É—Å—Ç"

        return generate_engagement(model_name, prompt_text)

    def generate_all_engagements(model_name, prompt_expert, prompt_problem, prompt_care, prompt_questions):

        results = []
        engagement_types = ["–Ø —ç–∫—Å–ø–µ—Ä—Ç", "–ß–µ—Ä–µ–∑ –ø—Ä–æ–±–ª–µ–º—É", "–ß–µ—Ä–µ–∑ –∑–∞–±–æ—Ç—É", "–ß–µ—Ä–µ–∑ –≤–æ–ø—Ä–æ—Å—ã"]
        prompts = [prompt_expert, prompt_problem, prompt_care, prompt_questions]

        for i, (engagement_type, prompt_text) in enumerate(zip(engagement_types, prompts)):
            if not prompt_text or not prompt_text.strip():
                results.append(f"–û—à–∏–±–∫–∞: –ü—Ä–æ–º–ø—Ç –¥–ª—è '{engagement_type}' –ø—É—Å—Ç")
            else:
                result = generate_engagement(model_name, prompt_text)
                results.append(result)

        return tuple(results)

    def refine_engagement(model_name, base_prompt, prev_answer, clarification):

        try:
            if not base_prompt or not base_prompt.strip():
                return "–û—à–∏–±–∫–∞: –ü—Ä–æ–º–ø—Ç –Ω–µ —É–∫–∞–∑–∞–Ω"

            clarification = clarification.strip() if clarification else ""

            if clarification:
                full_prompt = build_refine_prompt(
                    base_prompt, prev_answer or "", clarification
                )
            else:

                full_prompt = base_prompt.strip()

            result = generate_engagement(model_name, full_prompt)
            return result

        except Exception as e:
            return f"–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {str(e)}"

    def refine_engagement_1(model_name, base_prompt, prev_answer, clarification):

        return refine_engagement(model_name, base_prompt, prev_answer, clarification)

    def refine_engagement_2(model_name, base_prompt, prev_answer, clarification):

        return refine_engagement(model_name, base_prompt, prev_answer, clarification)

    def refine_engagement_3(model_name, base_prompt, prev_answer, clarification):

        return refine_engagement(model_name, base_prompt, prev_answer, clarification)

    def refine_engagement_4(model_name, base_prompt, prev_answer, clarification):

        return refine_engagement(model_name, base_prompt, prev_answer, clarification)

    def parse_page(url):

        if not url or not url.strip():
            return "–û—à–∏–±–∫–∞: URL –Ω–µ —É–∫–∞–∑–∞–Ω"

        try:

            options = webdriver.ChromeOptions()
            options.add_argument('--headless')
            options.add_argument('--no-sandbox')
            options.add_argument('--disable-dev-shm-usage')
            options.add_argument('user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36')

            service = ChromeService(ChromeDriverManager().install())
            driver = webdriver.Chrome(service=service, options=options)

            print(f"–ó–∞–≥—Ä—É–∂–∞—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ Selenium: {url}")
            driver.get(url)

            WebDriverWait(driver, 15).until(EC.presence_of_element_located((By.TAG_NAME, "h1")))

            html = driver.page_source
            driver.quit()

            if html:

                soup = BeautifulSoup(html, 'lxml')

                for script in soup(["script", "style", "nav", "header", "footer"]):
                    script.decompose()

                text = soup.body.get_text(separator='\n', strip=True) if soup.body else soup.get_text(separator='\n', strip=True)

                lines = [line.strip() for line in text.split('\n') if line.strip()]
                cleaned_text = '\n'.join(lines)

                return cleaned_text if cleaned_text else "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
            else:
                return "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã"

        except Exception as selenium_error:
            if 'driver' in locals():
                try:
                    driver.quit()
                except:
                    pass

            print(f"Selenium –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ({str(selenium_error)}), –ø—Ä–æ–±—É—é requests...")

            try:
                headers = {
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36',
                    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
                    'Accept-Language': 'ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3',
                    'Accept-Encoding': 'gzip, deflate',
                    'Connection': 'keep-alive',
                    'Upgrade-Insecure-Requests': '1',
                }

                print(f"–ó–∞–≥—Ä—É–∂–∞—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ requests: {url}")
                response = requests.get(url, headers=headers, timeout=30, verify=False)
                response.raise_for_status()

                soup = BeautifulSoup(response.text, 'lxml')

                for script in soup(["script", "style", "nav", "header", "footer"]):
                    script.decompose()

                text = soup.body.get_text(separator='\n', strip=True) if soup.body else soup.get_text(separator='\n', strip=True)

                lines = [line.strip() for line in text.split('\n') if line.strip()]
                cleaned_text = '\n'.join(lines)

                return f"[–ü–∞—Ä—Å–∏–Ω–≥ —á–µ—Ä–µ–∑ requests]\n\n{cleaned_text}" if cleaned_text else "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"

            except Exception as requests_error:
                return f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:\nSelenium: {str(selenium_error)}\nRequests: {str(requests_error)}"

    def generate_engagements_only(
            llm_name: str,
            p_eng_standard,
            *task_prompts_and_srcs,
        ):

        task_prompts_list = list(task_prompts_and_srcs[:18])
        srcs = task_prompts_and_srcs[18:]

        task_essences_value = srcs[1] if len(srcs) > 1 else ""
        parsed_tasks = parse_task_essences(task_essences_value) if task_essences_value else []
        if parsed_tasks is None:
            parsed_tasks = []
        num_tasks = len(parsed_tasks)

        for idx in range(num_tasks):
            sec_name = f"–í–æ–≤–ª–µ—á–µ–Ω–∏–µ (—Å—É—Ç—å –∑–∞–¥–∞—á–∏ {idx + 1})"
            box = eng_boxes.get(sec_name)
            if box is not None:
                box.value = ""
        eng_boxes["–í–æ–≤–ª–µ—á–µ–Ω–∏–µ 1"].value = ""

        task_updates = []
        for i in range(num_tasks):
            sec_name = f"–í–æ–≤–ª–µ—á–µ–Ω–∏–µ-–∑–∞–¥–∞—á–∞-{i + 1}"
            gr.Info(f"–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±–ª–æ–∫–∞ ¬´{sec_name}¬ª...")
            prompt_value = task_prompts_list[i]
            txt = maybe_with_length(
                retry_llm(llm_name, prompt_value, *srcs, max_len=MAX_LEN_ENGAGEMENT)
            )
            task_updates.append(gr.update(value=txt, interactive=True))

        while len(task_updates) < 18:
            task_updates.append(gr.update(value="", interactive=True))

        gr.Info("–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±–ª–æ–∫–∞ ¬´–í–æ–≤–ª–µ—á–µ–Ω–∏–µ-1¬ª...")
        standard_text = maybe_with_length(
            retry_llm(llm_name, p_eng_standard, *srcs, max_len=MAX_LEN_ENGAGEMENT)
        )

        gr.Info("‚úîÔ∏è –ë–ª–æ–∫–∏ –≤–æ–≤–ª–µ—á–µ–Ω–∏–π –≥–æ—Ç–æ–≤—ã.")

        return task_updates + [gr.update(value=standard_text, interactive=True)]

    def generate_script(
            llm_name: str,
            p_eng_standard,
            p_adv1, p_adv2,
            p_cost, p_format,
            p_obj_detect,
            *task_prompts_and_srcs
        ):

        task_prompts_list = list(task_prompts_and_srcs[:18])
        srcs = task_prompts_and_srcs[18:]

        task_essences_value = srcs[1] if len(srcs) > 1 else ""
        parsed_tasks = parse_task_essences(task_essences_value) if task_essences_value else []
        num_tasks = len(parsed_tasks) if parsed_tasks else 0

        targets = []
        prompts = []
        sections = []

        for i in range(num_tasks):
            task_num = i + 1
            sec_name = f"–í–æ–≤–ª–µ—á–µ–Ω–∏–µ (—Å—É—Ç—å –∑–∞–¥–∞—á–∏ {task_num})"
            targets.append(eng_boxes[sec_name])
            prompts.append(task_prompts_list[i])
            sections.append(f"–í–æ–≤–ª–µ—á–µ–Ω–∏–µ-–∑–∞–¥–∞—á–∞-{task_num}")

        targets.append(eng_boxes["–í–æ–≤–ª–µ—á–µ–Ω–∏–µ 1"])
        prompts.append(p_eng_standard)
        sections.append("–í–æ–≤–ª–µ—á–µ–Ω–∏–µ-1")

        targets.extend([
            script_boxes["–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ 1"], script_boxes["–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ 2"],
            script_boxes["–°—Ç–æ–∏–º–æ—Å—Ç—å"], script_boxes["–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ"],
        ])
        prompts.extend([p_adv1, p_adv2, p_cost, p_format])
        sections.extend(["–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞-1", "–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞-2", "–°—Ç–æ–∏–º–æ—Å—Ç—å", "–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ"])

        for tb in targets:
            tb.value = ""

        results = []
        for sec, prm in zip(sections, prompts):
            gr.Info(f"–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±–ª–æ–∫–∞ ¬´{sec}¬ª...")
            if sec == "–°—Ç–æ–∏–º–æ—Å—Ç—å" and prm.startswith("–ü—Ä–æ–º–ø—Ç –¥–ª—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏"):
                txt = "–ë–ª–æ–∫ –Ω–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω, –ø–æ—Å–∫–æ–ª—å–∫—É –≤ –±—Ä–∏—Ñ–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏."
            elif sec == "–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ" and prm.startswith("–ü—Ä–æ–º–ø—Ç –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è"):
                txt = "–ë–ª–æ–∫ –Ω–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω, –ø–æ—Å–∫–æ–ª—å–∫—É –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏."
            else:
                if sec in ("–°—Ç–æ–∏–º–æ—Å—Ç—å", "–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ"):
                    limit = MAX_LEN_COST_DESIGN
                elif "–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞" in sec:
                    limit = MAX_LEN_ADVANTAGES
                elif "–í–æ–≤–ª–µ—á–µ–Ω–∏–µ" in sec:
                    limit = MAX_LEN_ENGAGEMENT
                else:
                    limit = MAX_LEN_GENERAL
                txt = maybe_with_length(retry_llm(llm_name, prm, *srcs, max_len=limit))

            results.append(txt)

        gr.Info("‚úîÔ∏è –û—Å–Ω–æ–≤–Ω—ã–µ –±–ª–æ–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞ –≥–æ—Ç–æ–≤—ã.")

        task_updates = []

        for i, txt in enumerate(results[:num_tasks]):
            task_num = i + 1
            if task_num % 3 == 0:
                txt = f"[–ó–∞–±–æ—Ç–∞] {txt}"
            task_updates.append(gr.update(value=txt, interactive=True))

        while len(task_updates) < 18:
            task_updates.append(gr.update(value="", interactive=True))

        remaining = results[num_tasks:]
        standard_result = remaining[0] if remaining else ""
        other_results = remaining[1:] if len(remaining) > 1 else []

        standard_update = gr.update(value=standard_result, interactive=True)
        other_updates = [gr.update(value=txt, interactive=True) for txt in other_results]

        return tuple(task_updates + [standard_update] + other_updates)

    def show_uploader():
        return gr.update(visible=True)

    def export_script(
        product, eng_standard,
        adv1, adv2, cost, formatting,
        *task_and_obj_boxes
    ):
        rows = [
            ("–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞", product),
        ]

        task_boxes = task_and_obj_boxes[:18]
        obj_boxes = task_and_obj_boxes[18:]

        for i, box in enumerate(task_boxes, 1):
            text = strip_length(box)
            if text:
                rows.append((f"–í–æ–≤–ª–µ—á–µ–Ω–∏–µ (—Å—É—Ç—å –∑–∞–¥–∞—á–∏ {i})", text))

        rows.extend([
            ("–í–æ–≤–ª–µ—á–µ–Ω–∏–µ 1",   strip_length(eng_standard)),
            ("–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ 1", strip_length(adv1)),
            ("–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ 2", strip_length(adv2)),
            ("–°—Ç–æ–∏–º–æ—Å—Ç—å",      strip_length(cost)),
            ("–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ",     strip_length(formatting)),
        ])

        num = 1
        for box in obj_boxes:
            text = strip_length(box)
            if text:
                rows.append((f"–í–æ–∑—Ä–∞–∂–µ–Ω–∏–µ {num}", text))
                num += 1

        wb = openpyxl.Workbook()
        ws = wb.active

        thin  = Side(style="thin")
        border= Border(left=thin, right=thin, top=thin, bottom=thin)

        for r, (k, v) in enumerate(rows, 1):
            ws[f"A{r}"] = k
            ws[f"A{r}"].font   = Font(bold=True)
            ws[f"B{r}"] = v

            for col in ("A", "B"):
                ws[f"{col}{r}"].border = border

        ws.column_dimensions["A"].width = 20
        ws.column_dimensions["B"].width = 45

        safe_name = re.sub(r"[^A-Za-z–ê-–Ø–∞-—è0-9 _()-]", "", product).strip()
        if not safe_name:
            safe_name = "sales_script"
        fname   = f"{safe_name}.xlsx"

        tmp_dir = tempfile.mkdtemp()
        path    = os.path.join(tmp_dir, fname)
        wb.save(path)

        safe_name = re.sub(r"[^A-Za-z–ê-–Ø–∞-—è0-9 _()-]", "", product).strip() or "sales_script"
        fname_local = f"{safe_name}.xlsx"

        tmp_dir = tempfile.mkdtemp()
        path    = os.path.join(tmp_dir, fname_local)
        wb.save(path)

        try:
            unix = int(time.time())
            fname_repo = f"{safe_name}_{unix}.xlsx"
            with open(path, "rb") as f:
                gh_write(
                    f"exports/{fname_repo}",
                    f.read(),
                    msg=f"export {fname_repo}"
                )
        except Exception as e:

            gr.Warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ GitHub: {e}")

        return gr.update(value=path, visible=True)

    def export_script_json(
        product, eng_standard,
        adv1, adv2, cost, formatting,
        *task_and_obj_boxes
    ):

        from collections import OrderedDict
        data = OrderedDict()
        data["–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞"] = product

        task_boxes = task_and_obj_boxes[:18]
        obj_boxes = task_and_obj_boxes[18:]

        for i, box in enumerate(task_boxes, 1):
            txt = strip_length(box)
            if txt:
                data[f"–í–æ–≤–ª–µ—á–µ–Ω–∏–µ (—Å—É—Ç—å –∑–∞–¥–∞—á–∏ {i})"] = txt

        data["–í–æ–≤–ª–µ—á–µ–Ω–∏–µ 1"] = strip_length(eng_standard)
        data["–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ 1"] = strip_length(adv1)
        data["–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ 2"] = strip_length(adv2)
        data["–°—Ç–æ–∏–º–æ—Å—Ç—å"] = strip_length(cost)
        data["–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ"] = strip_length(formatting)
        data["–í–æ–∑—Ä–∞–∂–µ–Ω–∏—è"] = []

        for box in obj_boxes:
            txt = strip_length(box)
            if txt:
                data["–í–æ–∑—Ä–∞–∂–µ–Ω–∏—è"].append(txt)

        safe_name = re.sub(r"[^A-Za-z–ê-–Ø–∞-—è0-9 _()-]", "", product).strip() or "sales_script"
        fname     = f"{safe_name}.json"
        tmp_dir   = tempfile.mkdtemp()
        path      = os.path.join(tmp_dir, fname)

        with open(path, "w", encoding="utf-8") as f:
            json.dump(data, f, ensure_ascii=False, indent=2)

        try:
            unix = int(time.time())
            fname_repo = f"{safe_name}_{unix}.json"
            with open(path, "rb") as fbin:
                gh_write(
                    f"exports/{fname_repo}",
                    fbin.read(),
                    msg=f"export {fname_repo}"
                )
        except Exception as e:
            gr.Warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å JSON –≤ GitHub: {e}")

        return gr.update(value=path, visible=True)

    btn_choose.click(show_uploader, outputs=file_uploader)
    btn_template.click(download_template,outputs=template_holder)
    product_list.change(
            fill_fields,
            inputs=product_list,
            outputs=boxes
    ).then(
            update_prompts,
            inputs=eng_inputs,
            outputs=[
                prompt_eng_standard,
                prompt_adv1, prompt_adv2,
                prompt_cost, prompt_format,
                prompt_obj_detect,
            ] + task_prompts,
    ).then(
        clear_engagements,
        outputs=[
            eng_boxes["–í–æ–≤–ª–µ—á–µ–Ω–∏–µ 1"], clar_boxes["–í–æ–≤–ª–µ—á–µ–Ω–∏–µ 1"],
        ]
    )
    file_uploader.upload(upload_and_fill,inputs=file_uploader,outputs=boxes).then(
        update_prompts,
        inputs=eng_inputs,
        outputs=[
            prompt_eng_standard,
            prompt_adv1, prompt_adv2,
            prompt_cost, prompt_format,
            prompt_obj_detect,
        ] + task_prompts,
    ).then(
        clear_engagements,
        outputs=[
            eng_boxes["–í–æ–≤–ª–µ—á–µ–Ω–∏–µ 1"], clar_boxes["–í–æ–≤–ª–µ—á–µ–Ω–∏–µ 1"],
        ]
    )

    generate_engagements_btn.click(
        change_tab,
        inputs=[gr.Number(value=2, visible=False)],
        outputs=tabs,
        queue=False,
    ).then(
        generate_engagements_only,
        inputs=[
            llm,
            prompt_eng_standard,
        ] + task_prompts + [
            product_essence, task_essences_tb, key_msg_tb, benefit_tb,
            advantage_tb, product_cost_tb, design_tb,
            func_tb, biz_info_tb,
        ],
        outputs=task_result_boxes + [
            eng_boxes["–í–æ–≤–ª–µ—á–µ–Ω–∏–µ 1"],
        ],
        queue=True,
    ).then(
        fn=None,
        js="() => window.requestAnimationFrame(()=>window.scrollTo(0,0))",
        outputs=tabs,
    )

    btn_to_prompts.click(change_tab,inputs=[gr.Number(value=1,visible=False)],outputs=tabs)\
                  .then(fn=None,js="() => window.requestAnimationFrame(()=>window.scrollTo(0,0))")

    btn_to_script.click(
        change_tab,
        inputs=[gr.Number(value=2, visible=False)],
        outputs=tabs
    ).then(
        fn=None,
        js="() => window.requestAnimationFrame(()=>window.scrollTo(0,0))",
        outputs=tabs
    )

    btn_to_script.click(
        validate_product_name,
        inputs=[product_name],
        outputs=None,
        queue=False,
    ).then(
        change_tab,
        inputs=[gr.Number(value=2, visible=False)],
        outputs=tabs,
        queue=False,
    ).then(
        generate_script,
        inputs=[
            llm,
            prompt_eng_standard,
            prompt_adv1, prompt_adv2,
            prompt_cost, prompt_format,
            prompt_obj_detect,
        ] + task_prompts + [
            product_essence, task_essences_tb, key_msg_tb, benefit_tb,
            advantage_tb, product_cost_tb, design_tb,
            func_tb, biz_info_tb,
        ],
        outputs=task_result_boxes + [
            eng_boxes["–í–æ–≤–ª–µ—á–µ–Ω–∏–µ 1"],
            script_boxes["–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ 1"], script_boxes["–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ 2"],
            script_boxes["–°—Ç–æ–∏–º–æ—Å—Ç—å"], script_boxes["–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ"],
        ],
        queue=True,
    ).then(

        process_all_objections,
        inputs=[
            FIELD_BOXES["–í–æ–∑–º–æ–∂–Ω—ã–µ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ –∏ –æ—Ç–≤–µ—Ç—ã"],
            llm,
            prompt_obj_detect,
            product_name,
            product_essence,
            func_tb,
            benefit_tb,
            FIELD_BOXES["–ö–∞–∫ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç"],
            product_cost_tb,
            advantage_tb,
            biz_info_tb,
            key_msg_tb
        ],
        outputs=(
            [OBJ_ROWS[f"–í–æ–∑—Ä–∞–∂–µ–Ω–∏–µ {i}"] for i in range(1, MAX_OBJS + 1)] +
            [script_boxes[f"–í–æ–∑—Ä–∞–∂–µ–Ω–∏–µ {i}"] for i in range(1, MAX_OBJS + 1)] +
            [REGEN_BUTTONS[f"–í–æ–∑—Ä–∞–∂–µ–Ω–∏–µ {i}"] for i in range(1, MAX_OBJS + 1)] +
            LLM_PROMPT_BOXES +
            [HIDDEN_PROMPT_BOXES[f"–í–æ–∑—Ä–∞–∂–µ–Ω–∏–µ {i}"] for i in range(1, MAX_OBJS + 1)]
        ),
        queue=True,
    ).then(
        save_prompts,
        inputs=[
            llm,
            prompt_eng_standard,
            eng_boxes["–í–æ–≤–ª–µ—á–µ–Ω–∏–µ 1"],
        ],
        outputs=[],
        queue=False,
    )

    btn_export.click(
        export_script,
        inputs=[
            product_name,
            script_boxes["–í–æ–≤–ª–µ—á–µ–Ω–∏–µ 1"],
            script_boxes["–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ 1"],
            script_boxes["–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ 2"],
            script_boxes["–°—Ç–æ–∏–º–æ—Å—Ç—å"],
            script_boxes["–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ"],
            *[eng_boxes[f"–í–æ–≤–ª–µ—á–µ–Ω–∏–µ (—Å—É—Ç—å –∑–∞–¥–∞—á–∏ {i})"] for i in range(1, 19)],
            *[script_boxes[f"–í–æ–∑—Ä–∞–∂–µ–Ω–∏–µ {i}"] for i in range(1, MAX_OBJS + 1)]
        ],
        outputs=file_export,
        queue=False,
    )

    btn_export_json.click(
        export_script_json,
        inputs=[
            product_name,
            script_boxes["–í–æ–≤–ª–µ—á–µ–Ω–∏–µ 1"],
            script_boxes["–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ 1"],
            script_boxes["–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ 2"],
            script_boxes["–°—Ç–æ–∏–º–æ—Å—Ç—å"],
            script_boxes["–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ"],
            *[eng_boxes[f"–í–æ–≤–ª–µ—á–µ–Ω–∏–µ (—Å—É—Ç—å –∑–∞–¥–∞—á–∏ {i})"] for i in range(1, 19)],
            *[script_boxes[f"–í–æ–∑—Ä–∞–∂–µ–Ω–∏–µ {i}"] for i in range(1, MAX_OBJS + 1)]
        ],
        outputs=file_export_json,
        queue=False,
    )

    submit_feedback.click(
        prepare_button_text,
        outputs=submit_feedback
    ).then(
        save_comment,
        inputs=feedback_box,
        outputs=submit_feedback
    ).then(
        reset_button_text,
        outputs=submit_feedback,
        queue=False
    )

    def parse_and_fill_prompts(url):

        parsed_content = parse_page(url)

        expert_p, problem_p, care_p, questions_p = generate_prompts(parsed_content)
        return parsed_content, expert_p, problem_p, care_p, questions_p

    parse_btn.click(
        parse_and_fill_prompts,
        inputs=url_input,
        outputs=[page_content, prompt_expert, prompt_problem, prompt_care, prompt_questions],
        queue=True
    )

    page_content.change(
        generate_prompts,
        inputs=page_content,
        outputs=[prompt_expert, prompt_problem, prompt_care, prompt_questions],
        queue=False
    )

    generate_all_btn.click(
        generate_all_engagements,
        inputs=[model_dropdown, prompt_expert, prompt_problem, prompt_care, prompt_questions],
        outputs=[engagement_expert, engagement_problem, engagement_care, engagement_questions],
        queue=True
    )

    generate_btn_1.click(
        lambda model, prompt: generate_single_engagement(model, prompt, "–Ø —ç–∫—Å–ø–µ—Ä—Ç"),
        inputs=[model_dropdown, prompt_expert],
        outputs=engagement_expert,
        queue=True
    )

    generate_btn_2.click(
        lambda model, prompt: generate_single_engagement(model, prompt, "–ß–µ—Ä–µ–∑ –ø—Ä–æ–±–ª–µ–º—É"),
        inputs=[model_dropdown, prompt_problem],
        outputs=engagement_problem,
        queue=True
    )

    generate_btn_3.click(
        lambda model, prompt: generate_single_engagement(model, prompt, "–ß–µ—Ä–µ–∑ –∑–∞–±–æ—Ç—É"),
        inputs=[model_dropdown, prompt_care],
        outputs=engagement_care,
        queue=True
    )

    generate_btn_4.click(
        lambda model, prompt: generate_single_engagement(model, prompt, "–ß–µ—Ä–µ–∑ –≤–æ–ø—Ä–æ—Å—ã"),
        inputs=[model_dropdown, prompt_questions],
        outputs=engagement_questions,
        queue=True
    )

    regen_btn_1.click(
        lambda model, prompt, prev_answer, clarification: (
            refine_engagement_1(model, prompt, prev_answer, clarification),
            ""
        ),
        inputs=[model_dropdown, prompt_expert, engagement_expert, comment_1],
        outputs=[engagement_expert, comment_1],
        queue=True
    )

    regen_btn_2.click(
        lambda model, prompt, prev_answer, clarification: (
            refine_engagement_2(model, prompt, prev_answer, clarification),
            ""
        ),
        inputs=[model_dropdown, prompt_problem, engagement_problem, comment_2],
        outputs=[engagement_problem, comment_2],
        queue=True
    )

    regen_btn_3.click(
        lambda model, prompt, prev_answer, clarification: (
            refine_engagement_3(model, prompt, prev_answer, clarification),
            ""
        ),
        inputs=[model_dropdown, prompt_care, engagement_care, comment_3],
        outputs=[engagement_care, comment_3],
        queue=True
    )

    regen_btn_4.click(
        lambda model, prompt, prev_answer, clarification: (
            refine_engagement_4(model, prompt, prev_answer, clarification),
            ""
        ),
        inputs=[model_dropdown, prompt_questions, engagement_questions, comment_4],
        outputs=[engagement_questions, comment_4],
        queue=True
    )

if __name__ == "__main__":
    demo.queue().launch(
        server_name="0.0.0.0",
        server_port=int(os.getenv("PORT", 7860)),
        auth=[(USERNAME, PASSWORD)]
    )